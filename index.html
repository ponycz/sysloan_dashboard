<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysLoan Dashboard | √övƒõrov√Ω Report</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --text-muted: #555570;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-orange: #f97316;
            --gradient-1: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 2rem; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo { display: flex; align-items: center; gap: 1rem; }

        .logo-icon {
            width: 48px; height: 48px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.25rem;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .logo h1 {
            font-size: 1.75rem; font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo span { font-size: 0.875rem; color: var(--text-muted); font-weight: 400; }

        .header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }

        .date-badge {
            background: var(--bg-card);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .data-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: rgba(245, 158, 11, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-4px); border-color: var(--accent-blue); box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15); }
        .stat-card:hover::before { opacity: 1; }
        .stat-card.danger::before { background: var(--gradient-danger); }
        .stat-card.warning::before { background: var(--gradient-warning); }
        .stat-card.success::before { background: var(--gradient-2); }

        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; }
        .stat-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-bottom: 0.25rem; }
        .stat-value.danger { color: var(--accent-red); }
        .stat-value.warning { color: var(--accent-yellow); }
        .stat-value.success { color: var(--accent-green); }
        .stat-sub { font-size: 0.75rem; color: var(--text-secondary); }

        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
        .section-title::before { content: ''; width: 4px; height: 24px; background: var(--gradient-1); border-radius: 2px; }

        .alerts-section { margin-bottom: 2rem; }
        .alerts-list { display: flex; flex-direction: column; gap: 1rem; }

        .alert-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .alert-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); }

        .alert-header {
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            gap: 1rem;
        }

        .alert-card.danger .alert-header { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%); border-bottom: 1px solid rgba(239, 68, 68, 0.2); }
        .alert-card.warning .alert-header { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(234, 179, 8, 0.05) 100%); border-bottom: 1px solid rgba(245, 158, 11, 0.2); }
        .alert-card.info .alert-header { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border-bottom: 1px solid rgba(59, 130, 246, 0.2); }

        .alert-title { font-weight: 600; display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
        .alert-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .alert-card.danger .alert-icon { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .alert-card.warning .alert-icon { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .alert-card.info .alert-icon { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        .alert-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; flex: 1; justify-content: flex-end; }
        .alert-count { color: var(--text-primary); font-weight: 600; }
        .alert-value { color: var(--text-secondary); }

        .alert-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .alert-card.expanded .alert-content { max-height: 600px; }

        .alert-items { padding: 1rem 1.25rem; max-height: 500px; overflow-y: auto; }

        .alert-item {
            padding: 0.75rem;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-item:last-child { margin-bottom: 0; }
        .alert-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }

        .alert-item-status {
            flex-shrink: 0;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .alert-item-status.splaceno { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .alert-item-status.nesplaceno { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .alert-item-meta { font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); white-space: nowrap; font-size: 0.75rem; flex-shrink: 0; }

        .alert-toggle { width: 24px; height: 24px; border-radius: 6px; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; flex-shrink: 0; }
        .alert-card.expanded .alert-toggle { transform: rotate(180deg); }

        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap; }
        .tab { padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 500; color: var(--text-muted); background: transparent; border: none; cursor: pointer; transition: all 0.2s ease; position: relative; font-family: inherit; }
        .tab::after { content: ''; position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 2px; background: transparent; transition: background 0.2s ease; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-blue); }
        .tab.active::after { background: var(--accent-blue); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; }
        .chart-title { font-size: 1rem; font-weight: 600; margin-bottom: 1.25rem; color: var(--text-secondary); }
        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 450px; }

        .filters-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .filter-group { display: flex; flex-direction: column; gap: 0.375rem; }
        .filter-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 600; }

        .filter-select, .filter-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-family: inherit;
            min-width: 150px;
            transition: all 0.2s ease;
        }

        .filter-select:focus, .filter-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .filter-input { min-width: 200px; }

        .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease; border: none; font-family: inherit; }
        .btn-primary { background: var(--gradient-1); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--bg-card-hover); color: var(--text-primary); }

        .filter-spacer { flex: 1; }
        .results-count { font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; color: var(--text-secondary); }
        .results-count strong { color: var(--accent-blue); }

        .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .table-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .table-title { font-size: 1.125rem; font-weight: 600; }
        .table-wrapper { overflow-x: auto; max-height: 600px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { position: sticky; top: 0; background: var(--bg-card); padding: 0.875rem 0.75rem; text-align: left; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.65rem; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; transition: color 0.2s ease; z-index: 10; }
        th:hover { color: var(--accent-blue); }
        th.sorted-asc::after { content: ' ‚ñ≤'; color: var(--accent-blue); }
        th.sorted-desc::after { content: ' ‚ñº'; color: var(--accent-blue); }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
        tr:hover td { background: var(--bg-card-hover); color: var(--text-primary); }

        .cell-name { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-primary); font-weight: 500; }
        .cell-owner { max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cell-number { font-family: 'JetBrains Mono', monospace; text-align: right; }

        .badge { display: inline-flex; align-items: center; padding: 0.2rem 0.5rem; border-radius: 5px; font-size: 0.7rem; font-weight: 600; }
        .badge-rating { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); }
        .badge-rating.a { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .badge-rating.b { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .badge-rating.c { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .badge-type { background: rgba(6, 182, 212, 0.15); color: var(--accent-cyan); }
        .badge-status { padding: 0.2rem 0.4rem; }
        .badge-status.splaceno { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .badge-status.nesplaceno { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .badge-warning { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); font-size: 0.65rem; }
        .badge-info { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); font-size: 0.65rem; }
        .badge-caution { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); font-size: 0.65rem; }

        .ltv-bar { width: 50px; height: 5px; background: var(--bg-dark); border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 0.4rem; }
        .ltv-fill { height: 100%; border-radius: 3px; background: var(--accent-green); transition: width 0.3s ease; }
        .ltv-fill.medium { background: var(--accent-yellow); }
        .ltv-fill.high { background: var(--accent-red); }

        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-top: 1px solid var(--border); flex-wrap: wrap; gap: 1rem; }
        .page-info { font-size: 0.8rem; color: var(--text-secondary); }
        .page-buttons { display: flex; gap: 0.375rem; }
        .page-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
        .page-btn:hover:not(:disabled) { background: var(--bg-card-hover); color: var(--text-primary); border-color: var(--accent-blue); }
        .page-btn.active { background: var(--gradient-1); border-color: transparent; color: white; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .owners-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .sub-section { margin-top: 2rem; }
        .sub-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid, .owners-grid { grid-template-columns: 1fr; }
            .filters-bar { flex-direction: column; align-items: stretch; }
            .filter-select, .filter-input { width: 100%; }
        }

        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; color: var(--text-muted); }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        
        .error-message { text-align: center; padding: 3rem; color: var(--accent-red); }
        .error-message h3 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">SL</div>
                <div>
                    <h1>SysLoan Dashboard</h1>
                    <span>Komplexn√≠ p≈ôehled √∫vƒõrov√©ho portfolia</span>
                </div>
            </div>
            <div class="header-right">
                <div class="data-note">‚ö†Ô∏è Statistiky bez <span id="missingDateCount">0</span> √∫vƒõr≈Ø bez data splatnosti</div>
                <div class="date-badge" id="dateBadge">üìÖ Naƒç√≠t√°n√≠...</div>
            </div>
        </header>

        <div id="mainContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Naƒç√≠t√°n√≠ dat z Google Sheets...</p>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // KONFIGURACE
        // =============================================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHKkUe_RodISX4BbRlCngrtIlRGIRJZH9Yk-cYjW_mXdFZuwd1NHz8f0jVMm6GYf2h/exec';
        
        // =============================================================================
        // GLOB√ÅLN√ç PROMƒöNN√â
        // =============================================================================
        let DATA = null;
        let currentPage = 1, pageSize = 25, sortColumn = null, sortDirection = 'asc', filteredData = [];
        let currentPageTranche = 1, sortColumnTranche = null, sortDirectionTranche = 'asc', filteredTranches = [];
        let ownersValueChart = null, ownersCountChart = null;
        let overviewCharts = {};

        // =============================================================================
        // POMOCN√â FUNKCE
        // =============================================================================
        const formatCurrency = (value) => value === null || value === undefined ? '-' : new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(value);
        const formatNumber = (value) => value === null || value === undefined ? '-' : new Intl.NumberFormat('cs-CZ').format(value);
        const formatPercent = (value) => value === null || value === undefined ? '-' : value.toFixed(1) + ' %';

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = parseDate(dateStr);
            if (!d) return dateStr;
            return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
        }

        function daysDiff(date1, date2) {
            return Math.floor((date1 - date2) / (1000 * 60 * 60 * 24));
        }

        // =============================================================================
        // NAƒåTEN√ç DAT
        // =============================================================================
        async function loadData() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const rawData = await response.json();
                if (rawData.error) throw new Error(rawData.error);
                
                // Transformovat data do form√°tu pro dashboard
                DATA = transformData(rawData);
                
                // Vykreslit dashboard
                renderDashboard();
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Zkontroluj, ≈æe data byla exportov√°na ze SysLoanu pomoc√≠ Tampermonkey skriptu.
                        </p>
                        <button onclick="loadData()" class="btn btn-primary" style="margin-top: 1.5rem;">Zkusit znovu</button>
                    </div>
                `;
            }
        }

        // =============================================================================
        // TRANSFORMACE DAT
        // =============================================================================
        function transformData(rawData) {
            const loans = rawData.loans || [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // P≈ôidat vypoƒçten√© hodnoty k √∫vƒõr≈Øm
            const processedLoans = loans.map(loan => {
                const dateParsed = parseDate(loan.datum_splatnosti);
                const daysToMaturity = dateParsed ? daysDiff(dateParsed, today) : null;
                const ltvUveru = loan.ltv_uveru ? loan.ltv_uveru * 100 : null;
                const ltvTranse = loan.ltv_transe ? loan.ltv_transe * 100 : null;
                
                return {
                    ...loan,
                    datum_splatnosti: formatDate(loan.datum_splatnosti),
                    datum_timestamp: dateParsed ? dateParsed.getTime() : null,
                    datum_parsed_valid: !!dateParsed,
                    days_to_maturity: daysToMaturity,
                    ltv_uveru: ltvUveru,
                    ltv_transe: ltvTranse,
                    velikost_zastavy: loan.zastava || 0,
                    uver_nad_ramec: loan.vyse_uveru > loan.vyse_ramec && loan.vyse_ramec > 0
                };
            });
            
            // Agregovat √∫vƒõry (seskupit tran≈°e do jednoho √∫vƒõru)
            const loansMap = new Map();
            processedLoans.forEach(item => {
                if (!loansMap.has(item.loan_id)) {
                    loansMap.set(item.loan_id, {
                        ...item,
                        tranches_count: 1,
                        vyse_uveru: item.vyse_uveru || 0,
                        velikost_zastavy: item.velikost_zastavy || 0
                    });
                } else {
                    const existing = loansMap.get(item.loan_id);
                    existing.tranches_count++;
                    existing.vyse_uveru = Math.max(existing.vyse_uveru, item.vyse_uveru || 0);
                    existing.velikost_zastavy = Math.max(existing.velikost_zastavy, item.velikost_zastavy || 0);
                }
            });
            const aggregatedLoans = Array.from(loansMap.values());
            
            // Vypoƒç√≠tat statistiky
            const loansWithDate = aggregatedLoans.filter(l => l.datum_parsed_valid);
            const loansWithoutDate = aggregatedLoans.filter(l => !l.datum_parsed_valid);
            const splaceno = loansWithDate.filter(l => l.stav_splaceni === 'Splaceno');
            const nesplaceno = loansWithDate.filter(l => l.stav_splaceni === 'Nesplaceno');
            const overdue = nesplaceno.filter(l => l.days_to_maturity !== null && l.days_to_maturity < 0);
            
            const totalValue = aggregatedLoans.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0);
            const totalCollateral = aggregatedLoans.reduce((sum, l) => sum + (l.velikost_zastavy || 0), 0);
            const ltvValues = aggregatedLoans.filter(l => l.ltv_uveru !== null).map(l => l.ltv_uveru);
            const avgLtv = ltvValues.length > 0 ? ltvValues.reduce((a, b) => a + b, 0) / ltvValues.length : 0;
            
            const stats = {
                total_loans: aggregatedLoans.length,
                total_loans_with_date: loansWithDate.length,
                total_loans_without_date: loansWithoutDate.length,
                total_tranches: processedLoans.length,
                total_value: totalValue,
                total_collateral: totalCollateral,
                avg_ltv: avgLtv,
                splaceno_count: splaceno.length,
                splaceno_value: splaceno.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                nesplaceno_count: nesplaceno.length,
                nesplaceno_value: nesplaceno.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                overdue_count: overdue.length,
                overdue_value: overdue.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0)
            };
            
            // Generovat insights/alerts
            const insights = generateInsights(aggregatedLoans, processedLoans, today);
            
            // Statistiky podle ratingu
            const ratingStatsAll = calculateRatingStats(aggregatedLoans);
            const ratingStatsSplaceno = calculateRatingStats(splaceno);
            const ratingStatsNesplaceno = calculateRatingStats(nesplaceno);
            
            // Statistiky podle typu
            const typeStatsAll = calculateTypeStats(aggregatedLoans);
            const typeStatsSplaceno = calculateTypeStats(splaceno);
            const typeStatsNesplaceno = calculateTypeStats(nesplaceno);
            
            // LTV distribuce
            const ltvDistAll = calculateLtvDistribution(aggregatedLoans);
            const ltvDistSplaceno = calculateLtvDistribution(splaceno);
            const ltvDistNesplaceno = calculateLtvDistribution(nesplaceno);
            
            // Statistiky stavu splacen√≠
            const statusStats = [
                { 'Stav splacen√≠': 'Nesplaceno', 'Loan ID': nesplaceno.length, 'V√Ω≈°e √∫vƒõru (Kƒç)': stats.nesplaceno_value },
                { 'Stav splacen√≠': 'Splaceno', 'Loan ID': splaceno.length, 'V√Ω≈°e √∫vƒõru (Kƒç)': stats.splaceno_value }
            ];
            
            // Distribuce tran≈°√≠
            const tranchesDist = calculateTrancheDistribution(aggregatedLoans);
            
            // Mƒõs√≠ƒçn√≠ splatnosti (nesplacen√©)
            const monthly = calculateMonthlyMaturity(nesplaceno);
            
            // Statistiky vlastn√≠k≈Ø
            const ownerStatsAll = calculateOwnerStats(aggregatedLoans);
            const ownerStatsSplaceno = calculateOwnerStats(splaceno);
            const ownerStatsNesplaceno = calculateOwnerStats(nesplaceno);
            
            // Distribuce poƒçtu vlastn√≠k≈Ø na √∫vƒõr
            const ownersPerLoanDist = calculateOwnersPerLoanDistribution(aggregatedLoans);
            
            // Distribuce v√Ω≈°e √∫vƒõr≈Ø
            const loanSizeDistAll = calculateLoanSizeDistribution(aggregatedLoans);
            const loanSizeDistSplaceno = calculateLoanSizeDistribution(splaceno);
            const loanSizeDistNesplaceno = calculateLoanSizeDistribution(nesplaceno);
            
            // Filtry
            const typy = [...new Set(aggregatedLoans.map(l => l.typ))].filter(Boolean).sort();
            const ratings = [...new Set(aggregatedLoans.map(l => l.rating))].filter(Boolean).sort();
            const stavy = [...new Set(aggregatedLoans.map(l => l.stav_splaceni))].filter(Boolean).sort();
            
            return {
                loans: aggregatedLoans,
                tranches: processedLoans,
                stats,
                insights,
                rating_stats_all: ratingStatsAll,
                rating_stats_splaceno: ratingStatsSplaceno,
                rating_stats_nesplaceno: ratingStatsNesplaceno,
                type_stats_all: typeStatsAll,
                type_stats_splaceno: typeStatsSplaceno,
                type_stats_nesplaceno: typeStatsNesplaceno,
                ltv_distribution_all: ltvDistAll,
                ltv_distribution_splaceno: ltvDistSplaceno,
                ltv_distribution_nesplaceno: ltvDistNesplaceno,
                status_stats: statusStats,
                tranches_distribution: tranchesDist,
                monthly,
                owner_stats_all: ownerStatsAll,
                owner_stats_splaceno: ownerStatsSplaceno,
                owner_stats_nesplaceno: ownerStatsNesplaceno,
                owners_per_loan_distribution: ownersPerLoanDist,
                loan_size_distribution_all: loanSizeDistAll,
                loan_size_distribution_splaceno: loanSizeDistSplaceno,
                loan_size_distribution_nesplaceno: loanSizeDistNesplaceno,
                filters: { typy, ratings, stavy },
                meta: rawData.meta || {},
                exportedAtFormatted: rawData.exportedAtFormatted || ''
            };
        }

        function generateInsights(loans, tranches, today) {
            const insights = [];
            
            // Po splatnosti (nesplacen√©)
            const overdue = loans.filter(l => l.stav_splaceni === 'Nesplaceno' && l.days_to_maturity !== null && l.days_to_maturity < 0);
            if (overdue.length > 0) {
                insights.push({
                    type: 'danger',
                    title: 'üö® √övƒõry po splatnosti (nesplacen√©)',
                    count: overdue.length,
                    value: overdue.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: overdue.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        date: l.datum_splatnosti,
                        days: Math.abs(l.days_to_maturity),
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Splatnost do 30 dn√≠ (nesplacen√©)
            const soon30 = loans.filter(l => l.stav_splaceni === 'Nesplaceno' && l.days_to_maturity !== null && l.days_to_maturity >= 0 && l.days_to_maturity <= 30);
            if (soon30.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Splatnost do 30 dn√≠ (nesplacen√©)',
                    count: soon30.length,
                    value: soon30.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: soon30.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        date: l.datum_splatnosti,
                        days: l.days_to_maturity,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Splatnost 30-90 dn√≠ (nesplacen√©)
            const soon90 = loans.filter(l => l.stav_splaceni === 'Nesplaceno' && l.days_to_maturity !== null && l.days_to_maturity > 30 && l.days_to_maturity <= 90);
            if (soon90.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Splatnost 30-90 dn√≠ (nesplacen√©)',
                    count: soon90.length,
                    value: soon90.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: soon90.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        date: l.datum_splatnosti,
                        days: l.days_to_maturity,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Vysok√© LTV (> 75%)
            const highLtv = loans.filter(l => l.ltv_uveru !== null && l.ltv_uveru > 75);
            if (highLtv.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Vysok√© LTV (> 75%)',
                    count: highLtv.length,
                    value: highLtv.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: highLtv.sort((a, b) => b.ltv_uveru - a.ltv_uveru).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        ltv: l.ltv_uveru,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // P≈ôekroƒçen√Ω r√°mec
            const overFrame = loans.filter(l => l.uver_nad_ramec);
            if (overFrame.length > 0) {
                insights.push({
                    type: 'danger',
                    title: 'üö® √övƒõry p≈ôekraƒçuj√≠c√≠ r√°mec',
                    count: overFrame.length,
                    value: overFrame.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: overFrame.slice(0, 20).map(l => ({
                        name: l.jmeno,
                        uver: l.vyse_uveru,
                        ramec: l.vyse_ramec,
                        diff: l.vyse_uveru - l.vyse_ramec,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Prodlou≈æen√© √∫vƒõry
            const prolonged = loans.filter(l => l.prodlouzeni && l.prodlouzeni > 0);
            if (prolonged.length > 0) {
                insights.push({
                    type: 'info',
                    title: '‚ÑπÔ∏è Prodlou≈æen√© √∫vƒõry',
                    count: prolonged.length,
                    value: prolonged.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: prolonged.sort((a, b) => b.prodlouzeni - a.prodlouzeni).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        prodlouzeni: l.prodlouzeni,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Bez data splatnosti
            const noDate = loans.filter(l => !l.datum_parsed_valid);
            if (noDate.length > 0) {
                insights.push({
                    type: 'info',
                    title: '‚ÑπÔ∏è √övƒõry bez data splatnosti',
                    count: noDate.length,
                    value: noDate.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: noDate.slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // √övƒõry s pohled√°vkou > 0
            const withPohledavka = loans.filter(l => l.pohledavka && l.pohledavka > 0);
            if (withPohledavka.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è √övƒõry s pohled√°vkou > 0',
                    count: withPohledavka.length,
                    value: withPohledavka.reduce((sum, l) => sum + (l.pohledavka || 0), 0),
                    items: withPohledavka.sort((a, b) => (b.pohledavka || 0) - (a.pohledavka || 0)).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        pohledavka: l.pohledavka,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            return insights;
        }

        function calculateRatingStats(loans) {
            const byRating = {};
            loans.forEach(l => {
                const rating = l.rating || 'N/A';
                if (!byRating[rating]) {
                    byRating[rating] = { count: 0, value: 0, ltvSum: 0, ltvCount: 0 };
                }
                byRating[rating].count++;
                byRating[rating].value += l.vyse_uveru || 0;
                if (l.ltv_uveru !== null) {
                    byRating[rating].ltvSum += l.ltv_uveru;
                    byRating[rating].ltvCount++;
                }
            });
            
            return Object.entries(byRating).map(([rating, data]) => ({
                Rating: rating,
                'Loan ID': data.count,
                'V√Ω≈°e √∫vƒõru (Kƒç)': data.value,
                LTV_num: data.ltvCount > 0 ? data.ltvSum / data.ltvCount : 0
            })).sort((a, b) => a.Rating.localeCompare(b.Rating));
        }

        function calculateTypeStats(loans) {
            const byType = {};
            loans.forEach(l => {
                const typ = l.typ || 'N/A';
                if (!byType[typ]) {
                    byType[typ] = { count: 0, value: 0 };
                }
                byType[typ].count++;
                byType[typ].value += l.vyse_uveru || 0;
            });
            
            return Object.entries(byType).map(([typ, data]) => ({
                'Typ √∫vƒõru': typ,
                'Loan ID': data.count,
                'V√Ω≈°e √∫vƒõru (Kƒç)': data.value
            }));
        }

        function calculateLtvDistribution(loans) {
            const ranges = [
                { range: '0-50%', min: 0, max: 50 },
                { range: '50-60%', min: 50, max: 60 },
                { range: '60-70%', min: 60, max: 70 },
                { range: '70-75%', min: 70, max: 75 },
                { range: '75-80%', min: 75, max: 80 },
                { range: '80%+', min: 80, max: Infinity }
            ];
            
            return ranges.map(r => {
                const inRange = loans.filter(l => l.ltv_uveru !== null && l.ltv_uveru > r.min && l.ltv_uveru <= r.max);
                return {
                    range: r.range,
                    count: inRange.length,
                    value: inRange.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0)
                };
            });
        }

        function calculateTrancheDistribution(loans) {
            const dist = {};
            loans.forEach(l => {
                const count = l.tranches_count || 1;
                if (!dist[count]) dist[count] = 0;
                dist[count]++;
            });
            
            return Object.entries(dist)
                .map(([tranches, count]) => ({ tranches: parseInt(tranches), count }))
                .sort((a, b) => a.tranches - b.tranches);
        }

        function calculateMonthlyMaturity(loans) {
            const monthly = {};
            loans.forEach(l => {
                if (!l.datum_timestamp) return;
                const d = new Date(l.datum_timestamp);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                if (!monthly[key]) monthly[key] = { count: 0, value: 0 };
                monthly[key].count++;
                monthly[key].value += l.vyse_uveru || 0;
            });
            
            return Object.entries(monthly)
                .map(([month, data]) => ({
                    month,
                    'Loan ID': data.count,
                    'V√Ω≈°e √∫vƒõru (Kƒç)': data.value
                }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        function calculateOwnerStats(loans) {
            const byOwner = {};
            loans.forEach(l => {
                const owner = l.vlastnik || 'N/A';
                if (!byOwner[owner]) {
                    byOwner[owner] = { count: 0, value: 0 };
                }
                byOwner[owner].count++;
                byOwner[owner].value += l.vyse_uveru || 0;
            });
            
            return Object.entries(byOwner)
                .map(([vlastnik, data]) => ({
                    vlastnik,
                    count: data.count,
                    value: data.value
                }))
                .sort((a, b) => b.value - a.value);
        }

        function calculateOwnersPerLoanDistribution(loans) {
            const dist = {};
            loans.forEach(l => {
                // Poƒçet vlastn√≠k≈Ø - pokud je vlastn√≠k string s ƒç√°rkami, spoƒç√≠t√°me je
                let ownerCount = 1;
                if (l.vlastnik) {
                    // P≈ôedpokl√°d√°me, ≈æe vlastn√≠ci jsou oddƒõleni ƒç√°rkou
                    ownerCount = (l.vlastnik.match(/,/g) || []).length + 1;
                }
                if (!dist[ownerCount]) dist[ownerCount] = 0;
                dist[ownerCount]++;
            });
            
            return Object.entries(dist)
                .map(([count, loans]) => ({ owners: parseInt(count), count: loans }))
                .sort((a, b) => a.owners - b.owners);
        }

        function calculateLoanSizeDistribution(loans) {
            const ranges = [
                { range: '0-5 mil.', min: 0, max: 5000000 },
                { range: '5-10 mil.', min: 5000000, max: 10000000 },
                { range: '10-20 mil.', min: 10000000, max: 20000000 },
                { range: '20-50 mil.', min: 20000000, max: 50000000 },
                { range: '50-100 mil.', min: 50000000, max: 100000000 },
                { range: '100-200 mil.', min: 100000000, max: 200000000 },
                { range: '200+ mil.', min: 200000000, max: Infinity }
            ];
            
            return ranges.map(r => {
                const inRange = loans.filter(l => l.vyse_uveru !== null && l.vyse_uveru > r.min && l.vyse_uveru <= r.max);
                return {
                    range: r.range,
                    count: inRange.length,
                    value: inRange.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0)
                };
            });
        }

        // =============================================================================
        // VYKRESLEN√ç DASHBOARDU
        // =============================================================================
        function formatTimestampPrague(isoString) {
            if (!isoString) return 'Nezn√°m√©';
            try {
                const d = new Date(isoString);
                if (isNaN(d.getTime())) return isoString;
                const pragueOptions = { timeZone: 'Europe/Prague', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                const parts = new Intl.DateTimeFormat('cs-CZ', pragueOptions).formatToParts(d);
                const get = (type) => parts.find(p => p.type === type)?.value || '';
                return `${get('year')}-${get('month')}-${get('day')} , ${get('hour')}:${get('minute')}:${get('second')}`;
            } catch (e) {
                return isoString;
            }
        }

        function renderDashboard() {
            // Aktualizovat timestamp
            const rawTimestamp = DATA.meta?.lastUpdate || DATA.meta?.exportedAt || '';
            const timestamp = formatTimestampPrague(rawTimestamp) || DATA.meta?.lastUpdateFormatted || DATA.exportedAtFormatted || 'Nezn√°m√©';
            document.getElementById('dateBadge').textContent = `üìÖ Data k ${timestamp}`;
            document.getElementById('missingDateCount').textContent = DATA.stats.total_loans_without_date;
            
            // Vykreslit hlavn√≠ obsah
            document.getElementById('mainContent').innerHTML = `
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="alerts-section">
                    <h2 class="section-title">‚ö†Ô∏è Upozornƒõn√≠ a Insights</h2>
                    <div class="alerts-list" id="alertsGrid"></div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="overview">üìä P≈ôehled</button>
                    <button class="tab" data-tab="table">üìã √övƒõry</button>
                    <button class="tab" data-tab="tranches">üìë Tran≈°e</button>
                    <button class="tab" data-tab="owners">üë• Vlastn√≠ci</button>
                </div>
                
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterOverviewStatus">
                                <option value="">V≈°e</option>
                                <option value="splaceno">Splacen√©</option>
                                <option value="nesplaceno">Nesplacen√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="charts-grid" id="chartsGrid"></div>
                </div>
                
                <!-- Table Tab -->
                <div id="table" class="tab-content">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Hledat</label>
                            <input type="text" class="filter-input" id="searchInput" placeholder="N√°zev √∫vƒõru nebo vlastn√≠k...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Typ √∫vƒõru</label>
                            <select class="filter-select" id="filterType"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rating</label>
                            <select class="filter-select" id="filterRating"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterStatus"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">LTV</label>
                            <select class="filter-select" id="filterLTV">
                                <option value="">V≈°e</option>
                                <option value="low">‚â§ 60%</option>
                                <option value="medium">60-75%</option>
                                <option value="high">> 75%</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Probl√©my</label>
                            <select class="filter-select" id="filterProblems">
                                <option value="">V≈°e</option>
                                <option value="overdue">Po splatnosti</option>
                                <option value="soon30">Splatnost do 30 dn√≠</option>
                                <option value="soon90">Splatnost do 90 dn√≠</option>
                                <option value="highltv">Vysok√© LTV (>75%)</option>
                                <option value="overframe">P≈ôekroƒçen√Ω r√°mec</option>
                                <option value="prolonged">Prodlou≈æeno</option>
                                <option value="nodate">Bez data splatnosti</option>
                            </select>
                        </div>
                        <div class="filter-spacer"></div>
                        <button class="btn btn-ghost" id="resetFilters">Resetovat</button>
                        <div class="results-count" id="resultsCount"></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header"><h3 class="table-title">Detailn√≠ p≈ôehled √∫vƒõr≈Ø</h3></div>
                        <div class="table-wrapper">
                            <table id="dataTable"><thead><tr id="tableHeader"></tr></thead><tbody id="tableBody"></tbody></table>
                        </div>
                        <div class="pagination">
                            <div class="page-info" id="pageInfo"></div>
                            <div class="page-buttons" id="pageButtons"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tranches Tab -->
                <div id="tranches" class="tab-content">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Hledat</label>
                            <input type="text" class="filter-input" id="searchInputTranche" placeholder="N√°zev √∫vƒõru...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rating</label>
                            <select class="filter-select" id="filterRatingTranche"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterStatusTranche"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">LTV tran≈°e</label>
                            <select class="filter-select" id="filterLTVTranche">
                                <option value="">V≈°e</option>
                                <option value="low">‚â§ 60%</option>
                                <option value="medium">60-75%</option>
                                <option value="high">> 75%</option>
                            </select>
                        </div>
                        <div class="filter-spacer"></div>
                        <button class="btn btn-ghost" id="resetFiltersTranche">Resetovat</button>
                        <div class="results-count" id="resultsCountTranche"></div>
                    </div>
                    <div class="table-card">
                        <div class="table-header"><h3 class="table-title">P≈ôehled tran≈°√≠</h3></div>
                        <div class="table-wrapper">
                            <table id="trancheTable"><thead><tr id="trancheTableHeader"></tr></thead><tbody id="trancheTableBody"></tbody></table>
                        </div>
                        <div class="pagination">
                            <div class="page-info" id="pageInfoTranche"></div>
                            <div class="page-buttons" id="pageButtonsTranche"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Owners Tab -->
                <div id="owners" class="tab-content">
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterOwnersStatus">
                                <option value="">V≈°e</option>
                                <option value="splaceno">Splacen√©</option>
                                <option value="nesplaceno">Nesplacen√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="owners-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">üèÜ Top 20 vlastn√≠k≈Ø podle objemu √∫vƒõr≈Ø</h3>
                            <div class="chart-container tall"><canvas id="ownersValueChart"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">üìä Top 20 vlastn√≠k≈Ø podle poƒçtu √∫vƒõr≈Ø</h3>
                            <div class="chart-container tall"><canvas id="ownersCountChart"></canvas></div>
                        </div>
                    </div>
                    <div class="sub-section">
                        <h3 class="sub-title">üìã Kompletn√≠ p≈ôehled vlastn√≠k≈Ø</h3>
                        <div class="table-card">
                            <div class="table-wrapper">
                                <table id="ownersTable"><thead><tr><th>Vlastn√≠k</th><th>Poƒçet √∫vƒõr≈Ø</th><th>Celkov√Ω objem</th><th>√ò na √∫vƒõr</th></tr></thead><tbody id="ownersTableBody"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Vykreslit jednotliv√© ƒç√°sti
            renderStats();
            renderAlerts();
            renderOverviewCharts('');
            populateFilters();
            applyFilters();
            applyFiltersTranche();
            setupEventListeners();
            renderOwnersTab('');
        }

        function renderStats() {
            const stats = DATA.stats;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-label">√övƒõr≈Ø (s datem)</div><div class="stat-value">${formatNumber(stats.total_loans_with_date)}</div><div class="stat-sub">z ${formatNumber(stats.total_loans)} celkem</div></div>
                <div class="stat-card"><div class="stat-label">Celkem tran≈°√≠</div><div class="stat-value">${formatNumber(stats.total_tranches)}</div><div class="stat-sub">v≈°echny tran≈°e</div></div>
                <div class="stat-card"><div class="stat-label">Objem √∫vƒõr≈Ø</div><div class="stat-value">${(stats.total_value / 1e9).toFixed(2)}</div><div class="stat-sub">mld. Kƒç</div></div>
                <div class="stat-card"><div class="stat-label">Velikost z√°stav</div><div class="stat-value">${(stats.total_collateral / 1e9).toFixed(2)}</div><div class="stat-sub">mld. Kƒç</div></div>
                <div class="stat-card"><div class="stat-label">Pr≈Ømƒõrn√© LTV</div><div class="stat-value">${stats.avg_ltv.toFixed(1)}%</div><div class="stat-sub">Loan-to-Value</div></div>
                <div class="stat-card success"><div class="stat-label">Splaceno</div><div class="stat-value success">${formatNumber(stats.splaceno_count)}</div><div class="stat-sub">${formatCurrency(stats.splaceno_value)}</div></div>
                <div class="stat-card warning"><div class="stat-label">Nesplaceno</div><div class="stat-value warning">${formatNumber(stats.nesplaceno_count)}</div><div class="stat-sub">${formatCurrency(stats.nesplaceno_value)}</div></div>
                <div class="stat-card danger"><div class="stat-label">Po splatnosti</div><div class="stat-value danger">${formatNumber(stats.overdue_count)}</div><div class="stat-sub">${formatCurrency(stats.overdue_value)}</div></div>
            `;
        }

        function renderAlerts() {
            const alerts = DATA.insights;
            if (alerts.length === 0) {
                document.getElementById('alertsGrid').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>≈Ω√°dn√° upozornƒõn√≠</p></div>';
                return;
            }
            document.getElementById('alertsGrid').innerHTML = alerts.map((alert, idx) => `
                <div class="alert-card ${alert.type}" id="alert-${idx}">
                    <div class="alert-header" onclick="toggleAlert(${idx})">
                        <div class="alert-title">
                            <div class="alert-icon">${alert.type === 'danger' ? 'üö®' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</div>
                            <span>${alert.title}</span>
                        </div>
                        <div class="alert-stats">
                            <span class="alert-count">${alert.count}√ó</span>
                            <span class="alert-value">${formatCurrency(alert.value)}</span>
                        </div>
                        <div class="alert-toggle">‚ñº</div>
                    </div>
                    <div class="alert-content"><div class="alert-items">${renderAlertItems(alert)}</div></div>
                </div>
            `).join('');
        }

        function renderAlertItems(alert) {
            return alert.items.map(item => {
                const statusBadge = item.stav_splaceni ? `<span class="alert-item-status ${item.stav_splaceni === 'Splaceno' ? 'splaceno' : 'nesplaceno'}">${item.stav_splaceni}</span>` : '';
                
                if (alert.title.includes('po splatnosti')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">${item.date} (${item.days} dn√≠ po) ‚Ä¢ ${formatCurrency(item.value)}</span></div>`;
                } else if (alert.title.includes('Splatnost do') || alert.title.includes('30 dn√≠') || alert.title.includes('90 dn√≠')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">${item.date} (za ${item.days} dn√≠) ‚Ä¢ ${formatCurrency(item.value)}</span></div>`;
                } else if (alert.title.includes('LTV')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">LTV ${item.ltv.toFixed(1)}% ‚Ä¢ ${formatCurrency(item.value)}</span></div>`;
                } else if (alert.title.includes('r√°mec')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">+${formatCurrency(item.diff)} nad r√°mec ‚Ä¢ ${formatCurrency(item.uver)}</span></div>`;
                } else if (alert.title.includes('Prodlou≈æ')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">${item.prodlouzeni}√ó prodlou≈æeno ‚Ä¢ ${formatCurrency(item.value)}</span></div>`;
                } else if (alert.title.includes('pohled√°vkou')) {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">Pohled√°vka: ${formatCurrency(item.pohledavka)} ‚Ä¢ √övƒõr: ${formatCurrency(item.value)}</span></div>`;
                } else {
                    return `<div class="alert-item"><span class="alert-item-name">${item.name}</span>${statusBadge}<span class="alert-item-meta">${formatCurrency(item.value)}</span></div>`;
                }
            }).join('');
        }

        function toggleAlert(idx) { document.getElementById(`alert-${idx}`).classList.toggle('expanded'); }

        function renderOverviewCharts(statusFilter) {
            let ratingStats, typeStats, ltvDist, loanSizeDist;
            if (statusFilter === 'splaceno') {
                ratingStats = DATA.rating_stats_splaceno;
                typeStats = DATA.type_stats_splaceno;
                ltvDist = DATA.ltv_distribution_splaceno;
                loanSizeDist = DATA.loan_size_distribution_splaceno;
            } else if (statusFilter === 'nesplaceno') {
                ratingStats = DATA.rating_stats_nesplaceno;
                typeStats = DATA.type_stats_nesplaceno;
                ltvDist = DATA.ltv_distribution_nesplaceno;
                loanSizeDist = DATA.loan_size_distribution_nesplaceno;
            } else {
                ratingStats = DATA.rating_stats_all;
                typeStats = DATA.type_stats_all;
                ltvDist = DATA.ltv_distribution_all;
                loanSizeDist = DATA.loan_size_distribution_all;
            }

            Object.values(overviewCharts).forEach(c => c && c.destroy());
            overviewCharts = {};

            document.getElementById('chartsGrid').innerHTML = `
                <div class="chart-card"><h3 class="chart-title">üìä Rating ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="ratingCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ Rating ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="ratingValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìâ Rating ‚Äì pr≈Ømƒõrn√© LTV (%)</h3><div class="chart-container"><canvas id="avgLtvChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìà LTV ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="ltvCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ LTV ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="ltvValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìä Poƒçet tran≈°√≠ na √∫vƒõr</h3><div class="chart-container"><canvas id="tranchesDistChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üîÑ Typ √∫vƒõru ‚Äì poƒçet</h3><div class="chart-container"><canvas id="typeCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ Typ √∫vƒõru ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="typeValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üë• Poƒçet vlastn√≠k≈Ø na √∫vƒõr</h3><div class="chart-container"><canvas id="ownersPerLoanChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">‚úÖ Stav splacen√≠ ‚Äì poƒçet</h3><div class="chart-container"><canvas id="statusCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ Stav splacen√≠ ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="statusValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìä V√Ω≈°e √∫vƒõru ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="loanSizeCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ V√Ω≈°e √∫vƒõru ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="loanSizeValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìÖ Splatnost nesplacen√Ωch (mƒõs√≠ƒçnƒõ) ‚Äì poƒçet</h3><div class="chart-container"><canvas id="maturityCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ Splatnost nesplacen√Ωch (mƒõs√≠ƒçnƒõ) ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="maturityValueChart"></canvas></div></div>
            `;

            // 1. Rating ‚Äì poƒçet √∫vƒõr≈Ø
            const ratingStatsSorted = ratingStats.sort((a, b) => a.Rating.localeCompare(b.Rating));
            const ratingColors = ratingStatsSorted.map(r => r.Rating.startsWith('A') ? 'rgba(16, 185, 129, 0.8)' : r.Rating.startsWith('B') ? 'rgba(59, 130, 246, 0.8)' : 'rgba(245, 158, 11, 0.8)');

            overviewCharts.ratingCount = new Chart(document.getElementById('ratingCountChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: 'Poƒçet', data: ratingStatsSorted.map(r => r['Loan ID']), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 2. Rating ‚Äì objem
            overviewCharts.ratingValue = new Chart(document.getElementById('ratingValueChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: 'Objem (mld. Kƒç)', data: ratingStatsSorted.map(r => r['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 3. Rating ‚Äì pr≈Ømƒõrn√© LTV
            overviewCharts.avgLtv = new Chart(document.getElementById('avgLtvChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: 'Pr≈Ømƒõrn√© LTV (%)', data: ratingStatsSorted.map(r => r.LTV_num || 0), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 4. LTV ‚Äì poƒçet
            const ltvColors = ltvDist.map(d => d.range.includes('80') ? 'rgba(239, 68, 68, 0.8)' : d.range.includes('75') ? 'rgba(245, 158, 11, 0.8)' : 'rgba(16, 185, 129, 0.8)');

            overviewCharts.ltvCount = new Chart(document.getElementById('ltvCountChart'), {
                type: 'bar', data: { labels: ltvDist.map(d => d.range), datasets: [{ label: 'Poƒçet', data: ltvDist.map(d => d.count), backgroundColor: ltvColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 5. LTV ‚Äì objem
            overviewCharts.ltvValue = new Chart(document.getElementById('ltvValueChart'), {
                type: 'bar', data: { labels: ltvDist.map(d => d.range), datasets: [{ label: 'Objem (mld. Kƒç)', data: ltvDist.map(d => d.value / 1e9), backgroundColor: ltvColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 6. Poƒçet tran≈°√≠ na √∫vƒõr
            const tranchesDist = DATA.tranches_distribution;
            overviewCharts.tranchesDist = new Chart(document.getElementById('tranchesDistChart'), {
                type: 'bar', data: { labels: tranchesDist.map(d => d.tranches + ' tran≈°' + (d.tranches === 1 ? 'e' : d.tranches < 5 ? 'e' : '√≠')), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: tranchesDist.map(d => d.count), backgroundColor: 'rgba(139, 92, 246, 0.7)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 7. Typ √∫vƒõru ‚Äì poƒçet
            overviewCharts.typeCount = new Chart(document.getElementById('typeCountChart'), {
                type: 'doughnut', data: { labels: typeStats.map(t => t['Typ √∫vƒõru']), datasets: [{ data: typeStats.map(t => t['Loan ID']), backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 8. Typ √∫vƒõru ‚Äì objem
            overviewCharts.typeValue = new Chart(document.getElementById('typeValueChart'), {
                type: 'doughnut', data: { labels: typeStats.map(t => t['Typ √∫vƒõru']), datasets: [{ data: typeStats.map(t => t['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 9. Poƒçet vlastn√≠k≈Ø na √∫vƒõr
            const ownersPerLoanDist = DATA.owners_per_loan_distribution;
            overviewCharts.ownersPerLoan = new Chart(document.getElementById('ownersPerLoanChart'), {
                type: 'bar', data: { labels: ownersPerLoanDist.map(d => d.owners + ' vlastn√≠k' + (d.owners === 1 ? '' : d.owners < 5 ? 'y' : '≈Ø')), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: ownersPerLoanDist.map(d => d.count), backgroundColor: 'rgba(6, 182, 212, 0.7)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 10. Stav splacen√≠ ‚Äì poƒçet
            const statusStats = DATA.status_stats;
            overviewCharts.statusCount = new Chart(document.getElementById('statusCountChart'), {
                type: 'doughnut', data: { labels: statusStats.map(s => s['Stav splacen√≠']), datasets: [{ data: statusStats.map(s => s['Loan ID']), backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 11. Stav splacen√≠ ‚Äì objem
            overviewCharts.statusValue = new Chart(document.getElementById('statusValueChart'), {
                type: 'doughnut', data: { labels: statusStats.map(s => s['Stav splacen√≠']), datasets: [{ data: statusStats.map(s => s['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 12. V√Ω≈°e √∫vƒõru ‚Äì poƒçet
            const loanSizeColors = loanSizeDist.map((d, i) => {
                const colors = ['rgba(16, 185, 129, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(6, 182, 212, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(249, 115, 22, 0.8)', 'rgba(239, 68, 68, 0.8)'];
                return colors[i % colors.length];
            });

            overviewCharts.loanSizeCount = new Chart(document.getElementById('loanSizeCountChart'), {
                type: 'bar', data: { labels: loanSizeDist.map(d => d.range), datasets: [{ label: 'Poƒçet', data: loanSizeDist.map(d => d.count), backgroundColor: loanSizeColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 13. V√Ω≈°e √∫vƒõru ‚Äì objem
            overviewCharts.loanSizeValue = new Chart(document.getElementById('loanSizeValueChart'), {
                type: 'bar', data: { labels: loanSizeDist.map(d => d.range), datasets: [{ label: 'Objem (mld. Kƒç)', data: loanSizeDist.map(d => d.value / 1e9), backgroundColor: loanSizeColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 14. Splatnost nesplacen√Ωch ‚Äì poƒçet
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const maturityData = DATA.monthly.filter(m => m.month >= currentMonth);
            
            overviewCharts.maturityCount = new Chart(document.getElementById('maturityCountChart'), {
                type: 'line', data: { labels: maturityData.map(m => m.month), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: maturityData.map(m => m['Loan ID']), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0', maxRotation: 45 } } } }
            });

            // 15. Splatnost nesplacen√Ωch ‚Äì objem
            overviewCharts.maturityValue = new Chart(document.getElementById('maturityValueChart'), {
                type: 'line', data: { labels: maturityData.map(m => m.month), datasets: [{ label: 'Objem (mld. Kƒç)', data: maturityData.map(m => m['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0', maxRotation: 45 } } } }
            });
        }

        function populateFilters() {
            DATA.filters.typy.forEach(t => { document.getElementById('filterType').innerHTML += `<option value="${t}">${t}</option>`; });
            DATA.filters.ratings.forEach(r => {
                document.getElementById('filterRating').innerHTML += `<option value="${r}">${r}</option>`;
                document.getElementById('filterRatingTranche').innerHTML += `<option value="${r}">${r}</option>`;
            });
            DATA.filters.stavy.forEach(s => {
                document.getElementById('filterStatus').innerHTML += `<option value="${s}">${s}</option>`;
                document.getElementById('filterStatusTranche').innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const rating = document.getElementById('filterRating').value;
            const status = document.getElementById('filterStatus').value;
            const ltv = document.getElementById('filterLTV').value;
            const problems = document.getElementById('filterProblems').value;

            filteredData = DATA.loans.filter(item => {
                if (search && !item.jmeno.toLowerCase().includes(search) && !(item.vlastnik || '').toLowerCase().includes(search)) return false;
                if (type && item.typ !== type) return false;
                if (rating && item.rating !== rating) return false;
                if (status && item.stav_splaceni !== status) return false;
                if (ltv) {
                    if (ltv === 'low' && (item.ltv_uveru === null || item.ltv_uveru > 60)) return false;
                    if (ltv === 'medium' && (item.ltv_uveru === null || item.ltv_uveru <= 60 || item.ltv_uveru > 75)) return false;
                    if (ltv === 'high' && (item.ltv_uveru === null || item.ltv_uveru <= 75)) return false;
                }
                if (problems) {
                    if (problems === 'overdue' && (item.days_to_maturity === null || item.days_to_maturity >= 0 || item.stav_splaceni === 'Splaceno')) return false;
                    if (problems === 'soon30' && (item.days_to_maturity === null || item.days_to_maturity < 0 || item.days_to_maturity > 30 || item.stav_splaceni === 'Splaceno')) return false;
                    if (problems === 'soon90' && (item.days_to_maturity === null || item.days_to_maturity < 0 || item.days_to_maturity > 90 || item.stav_splaceni === 'Splaceno')) return false;
                    if (problems === 'highltv' && (item.ltv_uveru === null || item.ltv_uveru <= 75)) return false;
                    if (problems === 'overframe' && !item.uver_nad_ramec) return false;
                    if (problems === 'prolonged' && !item.prodlouzeni) return false;
                    if (problems === 'nodate' && item.datum_parsed_valid) return false;
                }
                return true;
            });

            if (sortColumn) {
                filteredData.sort((a, b) => {
                    let aVal = a[sortColumn], bVal = b[sortColumn];
                    if (sortColumn === 'datum_splatnosti') { aVal = a.datum_timestamp; bVal = b.datum_timestamp; }
                    if (aVal === null || aVal === undefined) aVal = sortDirection === 'asc' ? Infinity : -Infinity;
                    if (bVal === null || bVal === undefined) bVal = sortDirection === 'asc' ? Infinity : -Infinity;
                    if (typeof aVal === 'string') return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            currentPage = 1;
            renderTable();
            document.getElementById('resultsCount').innerHTML = `Zobrazeno <strong>${filteredData.length}</strong> z ${DATA.loans.length}`;
        }

        function renderTable() {
            const start = (currentPage - 1) * pageSize, end = start + pageSize, pageData = filteredData.slice(start, end);
            const headers = ['N√°zev √∫vƒõru', 'Vlastn√≠k', 'Typ', 'Tran≈°√≠', 'Rating', 'LTV', 'Splatnost', 'V√Ω≈°e √∫vƒõru', 'Z√°stava', 'Stav', 'Probl√©my'];
            const headerColumns = ['jmeno', 'vlastnik', 'typ', 'tranches_count', 'rating', 'ltv_uveru', 'datum_splatnosti', 'vyse_uveru', 'velikost_zastavy', 'stav_splaceni', ''];

            document.getElementById('tableHeader').innerHTML = headers.map((h, i) => {
                const col = headerColumns[i];
                return `<th class="${sortColumn === col ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}" data-column="${col}">${h}</th>`;
            }).join('');

            if (pageData.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="11" class="empty-state">≈Ω√°dn√© z√°znamy</td></tr>';
            } else {
                document.getElementById('tableBody').innerHTML = pageData.map(item => {
                    const problems = [];
                    if (!item.datum_parsed_valid) problems.push(`<span class="badge badge-info">Bez data</span>`);
                    else if (item.days_to_maturity !== null && item.days_to_maturity < 0 && item.stav_splaceni !== 'Splaceno') problems.push(`<span class="badge badge-warning">Po splatnosti ${Math.abs(item.days_to_maturity)}d</span>`);
                    else if (item.days_to_maturity !== null && item.days_to_maturity <= 30 && item.days_to_maturity >= 0 && item.stav_splaceni !== 'Splaceno') problems.push(`<span class="badge badge-caution">Brzy ${item.days_to_maturity}d</span>`);
                    if (item.ltv_uveru > 75) problems.push(`<span class="badge badge-warning">LTV ${item.ltv_uveru.toFixed(0)}%</span>`);
                    if (item.uver_nad_ramec) problems.push(`<span class="badge badge-warning">Nad r√°mec</span>`);
                    if (item.prodlouzeni) problems.push(`<span class="badge badge-info">Prodl. ${item.prodlouzeni}√ó</span>`);

                    const ratingClass = (item.rating || '').startsWith('A') ? 'a' : (item.rating || '').startsWith('B') ? 'b' : 'c';
                    const statusClass = item.stav_splaceni === 'Splaceno' ? 'splaceno' : 'nesplaceno';
                    const ltv = item.ltv_uveru;
                    const ltvClass = ltv > 75 ? 'high' : ltv > 65 ? 'medium' : '';
                    const ltvBar = ltv !== null ? `<span class="ltv-bar"><span class="ltv-fill ${ltvClass}" style="width: ${Math.min(ltv, 100)}%"></span></span>` : '';

                    return `<tr>
                        <td class="cell-name" title="${item.jmeno}">${item.jmeno}</td>
                        <td class="cell-owner" title="${item.vlastnik || ''}">${item.vlastnik || '-'}</td>
                        <td><span class="badge badge-type">${item.typ || '-'}</span></td>
                        <td class="cell-number">${item.tranches_count || 1}</td>
                        <td><span class="badge badge-rating ${ratingClass}">${item.rating || '-'}</span></td>
                        <td class="cell-number">${formatPercent(ltv)} ${ltvBar}</td>
                        <td>${item.datum_splatnosti || '-'}</td>
                        <td class="cell-number">${formatCurrency(item.vyse_uveru)}</td>
                        <td class="cell-number">${formatCurrency(item.velikost_zastavy)}</td>
                        <td><span class="badge badge-status ${statusClass}">${item.stav_splaceni || '-'}</span></td>
                        <td>${problems.join(' ') || '-'}</td>
                    </tr>`;
                }).join('');
            }

            const totalPages = Math.ceil(filteredData.length / pageSize) || 1;
            document.getElementById('pageInfo').textContent = `Str√°nka ${currentPage} z ${totalPages} (${filteredData.length} z√°znam≈Ø)`;
            let buttons = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(1)">¬´</button><button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">‚Äπ</button>`;
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            buttons += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">‚Ä∫</button><button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${totalPages})">¬ª</button>`;
            document.getElementById('pageButtons').innerHTML = buttons;
        }

        function goToPage(page) { currentPage = page; renderTable(); }

        function applyFiltersTranche() {
            const search = document.getElementById('searchInputTranche').value.toLowerCase();
            const rating = document.getElementById('filterRatingTranche').value;
            const status = document.getElementById('filterStatusTranche').value;
            const ltv = document.getElementById('filterLTVTranche').value;

            filteredTranches = DATA.tranches.filter(item => {
                if (item.typ !== 'Tran≈°ov√Ω') return false;
                if (search && !item.jmeno.toLowerCase().includes(search)) return false;
                if (rating && item.rating !== rating) return false;
                if (status && item.stav_splaceni !== status) return false;
                if (ltv) {
                    if (ltv === 'low' && (item.ltv_transe === null || item.ltv_transe > 60)) return false;
                    if (ltv === 'medium' && (item.ltv_transe === null || item.ltv_transe <= 60 || item.ltv_transe > 75)) return false;
                    if (ltv === 'high' && (item.ltv_transe === null || item.ltv_transe <= 75)) return false;
                }
                return true;
            });

            if (sortColumnTranche) {
                filteredTranches.sort((a, b) => {
                    let aVal = a[sortColumnTranche], bVal = b[sortColumnTranche];
                    if (sortColumnTranche === 'datum_splatnosti') { aVal = a.datum_timestamp; bVal = b.datum_timestamp; }
                    if (aVal === null || aVal === undefined) aVal = sortDirectionTranche === 'asc' ? Infinity : -Infinity;
                    if (bVal === null || bVal === undefined) bVal = sortDirectionTranche === 'asc' ? Infinity : -Infinity;
                    if (typeof aVal === 'string') return sortDirectionTranche === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    return sortDirectionTranche === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            currentPageTranche = 1;
            renderTranchesTable();
        }

        function renderTranchesTable() {
            const start = (currentPageTranche - 1) * pageSize, end = start + pageSize, pageData = filteredTranches.slice(start, end);
            const headers = ['N√°zev √∫vƒõru', 'Tran≈°e', 'Rating', 'LTV tran≈°e', 'Splatnost', 'V√Ω≈°e tran≈°e', 'V√Ω≈°e √∫vƒõru', 'Stav'];
            const headerColumns = ['jmeno', 'cislo_transe', 'rating', 'ltv_transe', 'datum_splatnosti', 'vyse_transe', 'vyse_uveru', 'stav_splaceni'];

            document.getElementById('trancheTableHeader').innerHTML = headers.map((h, i) => {
                const col = headerColumns[i];
                return `<th class="${sortColumnTranche === col ? (sortDirectionTranche === 'asc' ? 'sorted-asc' : 'sorted-desc') : ''}" data-column="${col}">${h}</th>`;
            }).join('');

            if (pageData.length === 0) {
                document.getElementById('trancheTableBody').innerHTML = '<tr><td colspan="8" class="empty-state">≈Ω√°dn√© tran≈°e</td></tr>';
            } else {
                document.getElementById('trancheTableBody').innerHTML = pageData.map(item => {
                    const ratingClass = (item.rating || '').startsWith('A') ? 'a' : (item.rating || '').startsWith('B') ? 'b' : 'c';
                    const statusClass = item.stav_splaceni === 'Splaceno' ? 'splaceno' : 'nesplaceno';
                    const ltv = item.ltv_transe;
                    const ltvClass = ltv > 75 ? 'high' : ltv > 65 ? 'medium' : '';
                    const ltvBar = ltv !== null ? `<span class="ltv-bar"><span class="ltv-fill ${ltvClass}" style="width: ${Math.min(ltv, 100)}%"></span></span>` : '';
                    return `<tr>
                        <td class="cell-name" title="${item.jmeno}">${item.jmeno}</td>
                        <td class="cell-number">${item.cislo_transe || '-'}</td>
                        <td><span class="badge badge-rating ${ratingClass}">${item.rating || '-'}</span></td>
                        <td class="cell-number">${formatPercent(ltv)} ${ltvBar}</td>
                        <td>${item.datum_splatnosti || '-'}</td>
                        <td class="cell-number">${formatCurrency(item.vyse_transe)}</td>
                        <td class="cell-number">${formatCurrency(item.vyse_uveru)}</td>
                        <td><span class="badge badge-status ${statusClass}">${item.stav_splaceni || '-'}</span></td>
                    </tr>`;
                }).join('');
            }

            const totalPages = Math.ceil(filteredTranches.length / pageSize) || 1;
            document.getElementById('pageInfoTranche').textContent = `Str√°nka ${currentPageTranche} z ${totalPages} (${filteredTranches.length} tran≈°√≠)`;
            document.getElementById('resultsCountTranche').innerHTML = `Zobrazeno <strong>${filteredTranches.length}</strong> tran≈°√≠`;
            let buttons = `<button class="page-btn" ${currentPageTranche === 1 ? 'disabled' : ''} onclick="goToPageTranche(1)">¬´</button><button class="page-btn" ${currentPageTranche === 1 ? 'disabled' : ''} onclick="goToPageTranche(${currentPageTranche - 1})">‚Äπ</button>`;
            for (let i = Math.max(1, currentPageTranche - 2); i <= Math.min(totalPages, currentPageTranche + 2); i++) buttons += `<button class="page-btn ${i === currentPageTranche ? 'active' : ''}" onclick="goToPageTranche(${i})">${i}</button>`;
            buttons += `<button class="page-btn" ${currentPageTranche === totalPages ? 'disabled' : ''} onclick="goToPageTranche(${currentPageTranche + 1})">‚Ä∫</button><button class="page-btn" ${currentPageTranche === totalPages ? 'disabled' : ''} onclick="goToPageTranche(${totalPages})">¬ª</button>`;
            document.getElementById('pageButtonsTranche').innerHTML = buttons;
        }

        function goToPageTranche(page) { currentPageTranche = page; renderTranchesTable(); }

        function renderOwnersTab(statusFilter) {
            let ownerData = statusFilter === 'splaceno' ? DATA.owner_stats_splaceno : statusFilter === 'nesplaceno' ? DATA.owner_stats_nesplaceno : DATA.owner_stats_all;
            const topByValue = ownerData.slice(0, 20);
            const topByCount = [...ownerData].sort((a, b) => b.count - a.count).slice(0, 20);

            if (ownersValueChart) ownersValueChart.destroy();
            if (ownersCountChart) ownersCountChart.destroy();

            ownersValueChart = new Chart(document.getElementById('ownersValueChart'), {
                type: 'bar', data: { labels: topByValue.map(o => o.vlastnik.length > 35 ? o.vlastnik.slice(0, 35) + '...' : o.vlastnik), datasets: [{ label: 'Objem (mil. Kƒç)', data: topByValue.map(o => o.value / 1e6), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, y: { grid: { display: false }, ticks: { color: '#8888a0', font: { size: 10 } } } } }
            });

            ownersCountChart = new Chart(document.getElementById('ownersCountChart'), {
                type: 'bar', data: { labels: topByCount.map(o => o.vlastnik.length > 35 ? o.vlastnik.slice(0, 35) + '...' : o.vlastnik), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: topByCount.map(o => o.count), backgroundColor: 'rgba(139, 92, 246, 0.7)', borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, y: { grid: { display: false }, ticks: { color: '#8888a0', font: { size: 10 } } } } }
            });

            document.getElementById('ownersTableBody').innerHTML = ownerData.map(o => `<tr><td class="cell-name">${o.vlastnik}</td><td class="cell-number">${o.count}</td><td class="cell-number">${formatCurrency(o.value)}</td><td class="cell-number">${formatCurrency(o.value / o.count)}</td></tr>`).join('');
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            ['searchInput', 'filterType', 'filterRating', 'filterStatus', 'filterLTV', 'filterProblems'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
                document.getElementById(id).addEventListener('change', applyFilters);
            });

            document.getElementById('resetFilters').addEventListener('click', () => {
                ['searchInput', 'filterType', 'filterRating', 'filterStatus', 'filterLTV', 'filterProblems'].forEach(id => document.getElementById(id).value = '');
                sortColumn = null; sortDirection = 'asc';
                applyFilters();
            });

            document.getElementById('tableHeader').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.column) return;
                if (sortColumn === th.dataset.column) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                else { sortColumn = th.dataset.column; sortDirection = 'asc'; }
                applyFilters();
            });

            ['searchInputTranche', 'filterRatingTranche', 'filterStatusTranche', 'filterLTVTranche'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFiltersTranche);
                document.getElementById(id).addEventListener('change', applyFiltersTranche);
            });

            document.getElementById('resetFiltersTranche').addEventListener('click', () => {
                ['searchInputTranche', 'filterRatingTranche', 'filterStatusTranche', 'filterLTVTranche'].forEach(id => document.getElementById(id).value = '');
                sortColumnTranche = null; sortDirectionTranche = 'asc';
                applyFiltersTranche();
            });

            document.getElementById('trancheTableHeader').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.column) return;
                if (sortColumnTranche === th.dataset.column) sortDirectionTranche = sortDirectionTranche === 'asc' ? 'desc' : 'asc';
                else { sortColumnTranche = th.dataset.column; sortDirectionTranche = 'asc'; }
                applyFiltersTranche();
            });

            document.getElementById('filterOwnersStatus').addEventListener('change', (e) => renderOwnersTab(e.target.value));
            document.getElementById('filterOverviewStatus').addEventListener('change', (e) => renderOverviewCharts(e.target.value));
        }

        // =============================================================================
        // START
        // =============================================================================
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
