<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysLoan Dashboard | √övƒõrov√Ω Report</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --text-muted: #555570;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-orange: #f97316;
            --gradient-1: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 24px; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 32px; padding: 20px 24px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
        }

        .logo { display: flex; align-items: center; gap: 16px; }
        .logo-icon {
            width: 48px; height: 48px; background: var(--gradient-1);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 18px; color: white;
        }
        .logo h1 { font-size: 24px; font-weight: 700; }
        .logo span { font-size: 14px; color: var(--text-secondary); }

        .header-right { display: flex; align-items: center; gap: 16px; }
        .data-note { font-size: 12px; color: var(--accent-yellow); background: rgba(245, 158, 11, 0.1); padding: 6px 12px; border-radius: 6px; }
        .date-badge { font-size: 13px; color: var(--text-secondary); background: var(--bg-card-hover); padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 32px;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
            transition: all 0.2s ease;
        }
        .stat-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .alerts-section { margin-bottom: 32px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .alerts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
        .alert-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .alert-card:hover { transform: translateY(-2px); }
        .alert-card.danger { border-left: 4px solid var(--accent-red); }
        .alert-card.warning { border-left: 4px solid var(--accent-yellow); }
        .alert-card.info { border-left: 4px solid var(--accent-blue); }
        .alert-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .alert-title { font-weight: 600; font-size: 14px; }
        .alert-count { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 20px; }
        .alert-value { font-size: 12px; color: var(--text-secondary); }
        .alert-items { margin-top: 12px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .alert-card.expanded .alert-items { max-height: 400px; overflow-y: auto; }
        .alert-item { font-size: 12px; padding: 6px 0; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
        .alert-item:first-child { border-top: none; }
        .alert-item-name { color: var(--text-primary); max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .alert-item-value { color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab {
            padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-secondary); cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.2s ease;
        }
        .tab:hover { border-color: var(--accent-blue); color: var(--text-primary); }
        .tab.active { background: var(--accent-blue); border-color: var(--accent-blue); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .filter-row { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-select, .filter-input {
            padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-primary); font-size: 13px; min-width: 140px;
        }
        .filter-select:focus, .filter-input:focus { outline: none; border-color: var(--accent-blue); }

        .charts-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; margin-bottom: 32px;
        }
        .chart-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
        }
        .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary); }
        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 400px; }

        .table-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; overflow: hidden;
        }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th {
            background: var(--bg-card-hover); color: var(--text-secondary);
            font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;
            cursor: pointer; user-select: none; white-space: nowrap;
        }
        th:hover { color: var(--text-primary); }
        th.sorted { color: var(--accent-blue); }
        th.sorted::after { content: ' ‚Üì'; }
        th.sorted.desc::after { content: ' ‚Üë'; }
        tr:hover { background: var(--bg-card-hover); }
        td { color: var(--text-primary); white-space: nowrap; }
        td.currency { font-family: 'JetBrains Mono', monospace; }
        .badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 600;
        }
        .badge.danger { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .badge.warning { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .badge.success { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .badge.info { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        .pagination {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-top: 1px solid var(--border);
        }
        .page-info { font-size: 13px; color: var(--text-secondary); }
        .page-buttons { display: flex; gap: 8px; }
        .page-btn {
            padding: 6px 12px; background: var(--bg-card-hover); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 13px;
        }
        .page-btn:hover { border-color: var(--accent-blue); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background: var(--accent-blue); border-color: var(--accent-blue); }

        .reset-btn {
            padding: 8px 16px; background: var(--accent-red); border: none;
            border-radius: 6px; color: white; cursor: pointer; font-size: 13px; font-weight: 500;
        }
        .reset-btn:hover { opacity: 0.9; }

        .owners-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .sub-section { margin-top: 32px; }
        .sub-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }

        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        
        .error-message { text-align: center; padding: 3rem; color: var(--accent-red); }
        .error-message h3 { margin-bottom: 1rem; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 16px; text-align: center; }
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .owners-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">SL</div>
                <div>
                    <h1>SysLoan Dashboard</h1>
                    <span>Komplexn√≠ p≈ôehled √∫vƒõrov√©ho portfolia</span>
                </div>
            </div>
            <div class="header-right">
                <div class="data-note">‚ö†Ô∏è Statistiky bez <span id="missingDateCount">0</span> √∫vƒõr≈Ø bez data splatnosti</div>
                <div class="date-badge" id="dateBadge">üìÖ Naƒç√≠t√°n√≠...</div>
            </div>
        </header>

        <div id="mainContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Naƒç√≠t√°n√≠ dat z Google Sheets...</p>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // KONFIGURACE
        // =============================================================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyeIxwaIs96MExSVBoJjTYVMiRbN027M5V5kbr7MPrZR6JqMb4Weho4IQK4BLtpSYvy/exec';
        
        // =============================================================================
        // GLOB√ÅLN√ç PROMƒöNN√â
        // =============================================================================
        let DATA = null;
        let currentPage = 1, pageSize = 25, sortColumn = null, sortDirection = 'asc', filteredData = [];
        let currentPageTranche = 1, sortColumnTranche = null, sortDirectionTranche = 'asc', filteredTranches = [];
        let ownersValueChart = null, ownersCountChart = null;
        let overviewCharts = {};

        // =============================================================================
        // POMOCN√â FUNKCE
        // =============================================================================
        const formatCurrency = (value) => value === null || value === undefined ? '-' : new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }).format(value);
        const formatNumber = (value) => value === null || value === undefined ? '-' : new Intl.NumberFormat('cs-CZ').format(value);
        const formatPercent = (value) => value === null || value === undefined ? '-' : value.toFixed(1) + ' %';

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? null : d;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = parseDate(dateStr);
            if (!d) return dateStr;
            return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
        }

        function formatDateTimePrague(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            if (isNaN(d.getTime())) return isoString;
            
            // Form√°tov√°n√≠ pro ƒçasov√© p√°smo Praha (Europe/Prague)
            const options = {
                timeZone: 'Europe/Prague',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            
            const formatter = new Intl.DateTimeFormat('cs-CZ', options);
            const parts = formatter.formatToParts(d);
            
            const dateParts = {};
            parts.forEach(p => { dateParts[p.type] = p.value; });
            
            return `Data k ${dateParts.year}-${dateParts.month}-${dateParts.day} , ${dateParts.hour}:${dateParts.minute}:${dateParts.second}`;
        }

        function daysDiff(date1, date2) {
            return Math.floor((date1 - date2) / (1000 * 60 * 60 * 24));
        }

        // =============================================================================
        // NAƒåTEN√ç DAT
        // =============================================================================
        async function loadData() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const rawData = await response.json();
                if (rawData.error) throw new Error(rawData.error);
                
                DATA = transformData(rawData);
                renderDashboard();
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Zkontroluj, ≈æe data byla exportov√°na ze SysLoanu pomoc√≠ Tampermonkey skriptu.
                        </p>
                    </div>
                `;
            }
        }

        // =============================================================================
        // TRANSFORMACE DAT
        // =============================================================================
        function transformData(raw) {
            const loans = raw.loans || [];
            const tranches = raw.tranches || [];
            const timestamp = raw.timestamp || new Date().toISOString();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Zpracov√°n√≠ √∫vƒõr≈Ø
            loans.forEach(loan => {
                loan.datum_parsed = parseDate(loan.datum_splatnosti);
                loan.datum_parsed_valid = loan.datum_parsed && !isNaN(loan.datum_parsed.getTime());
                if (loan.datum_parsed_valid) {
                    loan.days_to_maturity = daysDiff(loan.datum_parsed, today);
                }
            });
            
            // Statistiky
            const loansWithDate = loans.filter(l => l.datum_parsed_valid);
            const stats = {
                total_loans: loans.length,
                total_loans_with_date: loansWithDate.length,
                total_tranches: tranches.length,
                total_value: loans.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                total_receivables: loans.reduce((sum, l) => sum + (l.pohledavky || 0), 0),
                overdue_count: loansWithDate.filter(l => l.days_to_maturity < 0 && l.stav_splaceni !== 'Splaceno').length,
                due_30_days: loansWithDate.filter(l => l.days_to_maturity >= 0 && l.days_to_maturity <= 30 && l.stav_splaceni !== 'Splaceno').length,
                due_90_days: loansWithDate.filter(l => l.days_to_maturity >= 0 && l.days_to_maturity <= 90 && l.stav_splaceni !== 'Splaceno').length
            };
            
            // Insights
            const insights = generateInsights(loans, loansWithDate, today);
            
            // Rating stats
            const ratingStatsAll = calculateRatingStats(loans);
            const ratingStatsSplaceno = calculateRatingStats(loans.filter(l => l.stav_splaceni === 'Splaceno'));
            const ratingStatsNesplaceno = calculateRatingStats(loans.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Type stats
            const typeStatsAll = calculateTypeStats(loans);
            const typeStatsSplaceno = calculateTypeStats(loans.filter(l => l.stav_splaceni === 'Splaceno'));
            const typeStatsNesplaceno = calculateTypeStats(loans.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Status stats
            const statusStats = calculateStatusStats(loans);
            
            // LTV distribution
            const ltvDistributionAll = calculateLtvDistribution(loans);
            const ltvDistributionSplaceno = calculateLtvDistribution(loans.filter(l => l.stav_splaceni === 'Splaceno'));
            const ltvDistributionNesplaceno = calculateLtvDistribution(loans.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Loan value distribution (NEW)
            const loanValueDistributionAll = calculateLoanValueDistribution(loans);
            const loanValueDistributionSplaceno = calculateLoanValueDistribution(loans.filter(l => l.stav_splaceni === 'Splaceno'));
            const loanValueDistributionNesplaceno = calculateLoanValueDistribution(loans.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Tranches distribution
            const tranchesDistribution = calculateTranchesDistribution(loans);
            
            // Owners distribution (NEW)
            const ownersDistribution = calculateOwnersDistribution(loans);
            
            // Monthly maturity
            const monthlyNesplaceno = calculateMonthlyMaturity(loansWithDate.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Owner stats
            const ownerStats = calculateOwnerStats(loans);
            const ownerStatsSplaceno = calculateOwnerStats(loans.filter(l => l.stav_splaceni === 'Splaceno'));
            const ownerStatsNesplaceno = calculateOwnerStats(loans.filter(l => l.stav_splaceni !== 'Splaceno'));
            
            // Filters
            const filters = {
                typy: [...new Set(loans.map(l => l.typ_uveru).filter(Boolean))].sort(),
                ratings: [...new Set(loans.map(l => l.rating).filter(Boolean))].sort(),
                stavy: [...new Set(loans.map(l => l.stav_splaceni).filter(Boolean))].sort()
            };
            
            return {
                timestamp,
                stats,
                insights,
                loans,
                tranches,
                rating_stats_all: ratingStatsAll,
                rating_stats_splaceno: ratingStatsSplaceno,
                rating_stats_nesplaceno: ratingStatsNesplaceno,
                type_stats_all: typeStatsAll,
                type_stats_splaceno: typeStatsSplaceno,
                type_stats_nesplaceno: typeStatsNesplaceno,
                status_stats: statusStats,
                ltv_distribution_all: ltvDistributionAll,
                ltv_distribution_splaceno: ltvDistributionSplaceno,
                ltv_distribution_nesplaceno: ltvDistributionNesplaceno,
                loan_value_distribution_all: loanValueDistributionAll,
                loan_value_distribution_splaceno: loanValueDistributionSplaceno,
                loan_value_distribution_nesplaceno: loanValueDistributionNesplaceno,
                tranches_distribution: tranchesDistribution,
                owners_distribution: ownersDistribution,
                monthly: monthlyNesplaceno,
                owner_stats: ownerStats,
                owner_stats_splaceno: ownerStatsSplaceno,
                owner_stats_nesplaceno: ownerStatsNesplaceno,
                filters
            };
        }

        function generateInsights(loans, loansWithDate, today) {
            const insights = [];
            
            // Po splatnosti
            const overdue = loansWithDate.filter(l => l.days_to_maturity < 0 && l.stav_splaceni !== 'Splaceno');
            if (overdue.length > 0) {
                insights.push({
                    type: 'danger',
                    title: 'üö® Po splatnosti',
                    count: overdue.length,
                    value: overdue.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: overdue.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        extra: `${Math.abs(l.days_to_maturity)} dn√≠`
                    }))
                });
            }
            
            // Splatnost do 30 dn√≠
            const due30 = loansWithDate.filter(l => l.days_to_maturity >= 0 && l.days_to_maturity <= 30 && l.stav_splaceni !== 'Splaceno');
            if (due30.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Splatnost do 30 dn√≠',
                    count: due30.length,
                    value: due30.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: due30.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        extra: `${l.days_to_maturity} dn√≠`
                    }))
                });
            }
            
            // Splatnost do 90 dn√≠
            const due90 = loansWithDate.filter(l => l.days_to_maturity > 30 && l.days_to_maturity <= 90 && l.stav_splaceni !== 'Splaceno');
            if (due90.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Splatnost do 90 dn√≠',
                    count: due90.length,
                    value: due90.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: due90.sort((a, b) => a.days_to_maturity - b.days_to_maturity).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        extra: `${l.days_to_maturity} dn√≠`
                    }))
                });
            }
            
            // P≈ôekraƒçuje r√°mec
            const overFrame = loans.filter(l => l.uver_ramec === true || l.uver_ramec === 'Ano');
            if (overFrame.length > 0) {
                insights.push({
                    type: 'danger',
                    title: 'üö® P≈ôekraƒçuje r√°mec',
                    count: overFrame.length,
                    value: overFrame.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: overFrame.slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Vysok√© LTV (>75%)
            const highLtv = loans.filter(l => l.ltv > 75 && l.stav_splaceni !== 'Splaceno');
            if (highLtv.length > 0) {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Vysok√© LTV (>75%)',
                    count: highLtv.length,
                    value: highLtv.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: highLtv.sort((a, b) => (b.ltv || 0) - (a.ltv || 0)).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        extra: `LTV ${l.ltv?.toFixed(1)}%`
                    }))
                });
            }
            
            // Prodlou≈æen√©
            const extended = loans.filter(l => l.prodlouzeni === true || l.prodlouzeni === 'Ano');
            if (extended.length > 0) {
                insights.push({
                    type: 'info',
                    title: '‚ÑπÔ∏è Prodlou≈æen√© √∫vƒõry',
                    count: extended.length,
                    value: extended.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: extended.slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // Bez data splatnosti
            const noDate = loans.filter(l => !l.datum_parsed_valid);
            if (noDate.length > 0) {
                insights.push({
                    type: 'info',
                    title: '‚ÑπÔ∏è √övƒõry bez data splatnosti',
                    count: noDate.length,
                    value: noDate.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0),
                    items: noDate.slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.vyse_uveru,
                        stav_splaceni: l.stav_splaceni
                    }))
                });
            }
            
            // NOV√â: √övƒõry s kladnou pohled√°vkou
            const posReceivables = loans.filter(l => (l.pohledavky || 0) > 0);
            if (posReceivables.length > 0) {
                const totalReceivables = posReceivables.reduce((sum, l) => sum + (l.pohledavky || 0), 0);
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è √övƒõry s kladnou pohled√°vkou',
                    count: posReceivables.length,
                    value: totalReceivables,
                    items: posReceivables.sort((a, b) => (b.pohledavky || 0) - (a.pohledavky || 0)).slice(0, 20).map(l => ({
                        name: l.jmeno,
                        value: l.pohledavky,
                        extra: `√övƒõr: ${formatCurrency(l.vyse_uveru)}`
                    }))
                });
            }
            
            return insights;
        }

        function calculateRatingStats(loans) {
            const grouped = {};
            loans.forEach(l => {
                const rating = l.rating || 'N/A';
                if (!grouped[rating]) grouped[rating] = { 'Rating': rating, 'Loan ID': 0, 'V√Ω≈°e √∫vƒõru (Kƒç)': 0, ltvSum: 0 };
                grouped[rating]['Loan ID']++;
                grouped[rating]['V√Ω≈°e √∫vƒõru (Kƒç)'] += l.vyse_uveru || 0;
                grouped[rating].ltvSum += l.ltv || 0;
            });
            return Object.values(grouped).map(g => ({
                ...g,
                avgLtv: g['Loan ID'] > 0 ? g.ltvSum / g['Loan ID'] : 0
            }));
        }

        function calculateTypeStats(loans) {
            const grouped = {};
            loans.forEach(l => {
                const typ = l.typ_uveru || 'N/A';
                if (!grouped[typ]) grouped[typ] = { 'Typ √∫vƒõru': typ, 'Loan ID': 0, 'V√Ω≈°e √∫vƒõru (Kƒç)': 0 };
                grouped[typ]['Loan ID']++;
                grouped[typ]['V√Ω≈°e √∫vƒõru (Kƒç)'] += l.vyse_uveru || 0;
            });
            return Object.values(grouped);
        }

        function calculateStatusStats(loans) {
            const grouped = {};
            loans.forEach(l => {
                const stav = l.stav_splaceni || 'N/A';
                if (!grouped[stav]) grouped[stav] = { 'Stav splacen√≠': stav, 'Loan ID': 0, 'V√Ω≈°e √∫vƒõru (Kƒç)': 0 };
                grouped[stav]['Loan ID']++;
                grouped[stav]['V√Ω≈°e √∫vƒõru (Kƒç)'] += l.vyse_uveru || 0;
            });
            return Object.values(grouped);
        }

        function calculateLtvDistribution(loans) {
            const ranges = [
                { range: '0-50%', min: 0, max: 50 },
                { range: '50-60%', min: 50, max: 60 },
                { range: '60-70%', min: 60, max: 70 },
                { range: '70-75%', min: 70, max: 75 },
                { range: '75-80%', min: 75, max: 80 },
                { range: '80%+', min: 80, max: Infinity }
            ];
            
            return ranges.map(r => {
                const inRange = loans.filter(l => l.ltv >= r.min && l.ltv < r.max);
                return {
                    range: r.range,
                    count: inRange.length,
                    value: inRange.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0)
                };
            });
        }

        function calculateLoanValueDistribution(loans) {
            const ranges = [
                { range: '0-10 mil.', min: 0, max: 10000000 },
                { range: '10-20 mil.', min: 10000000, max: 20000000 },
                { range: '20-30 mil.', min: 20000000, max: 30000000 },
                { range: '30-50 mil.', min: 30000000, max: 50000000 },
                { range: '50-100 mil.', min: 50000000, max: 100000000 },
                { range: '100+ mil.', min: 100000000, max: Infinity }
            ];
            
            return ranges.map(r => {
                const inRange = loans.filter(l => (l.vyse_uveru || 0) >= r.min && (l.vyse_uveru || 0) < r.max);
                return {
                    range: r.range,
                    count: inRange.length,
                    value: inRange.reduce((sum, l) => sum + (l.vyse_uveru || 0), 0)
                };
            });
        }

        function calculateTranchesDistribution(loans) {
            const grouped = {};
            loans.forEach(l => {
                const count = l.pocet_transi || 1;
                if (!grouped[count]) grouped[count] = { tranches: count, count: 0 };
                grouped[count].count++;
            });
            return Object.values(grouped).sort((a, b) => a.tranches - b.tranches);
        }

        function calculateOwnersDistribution(loans) {
            const grouped = {};
            loans.forEach(l => {
                const count = l.pocet_vlastniku || 1;
                if (!grouped[count]) grouped[count] = { owners: count, count: 0 };
                grouped[count].count++;
            });
            return Object.values(grouped).sort((a, b) => a.owners - b.owners);
        }

        function calculateMonthlyMaturity(loans) {
            const grouped = {};
            loans.forEach(l => {
                if (!l.datum_parsed_valid) return;
                const month = `${l.datum_parsed.getFullYear()}-${String(l.datum_parsed.getMonth() + 1).padStart(2, '0')}`;
                if (!grouped[month]) grouped[month] = { month, 'Loan ID': 0, 'V√Ω≈°e √∫vƒõru (Kƒç)': 0 };
                grouped[month]['Loan ID']++;
                grouped[month]['V√Ω≈°e √∫vƒõru (Kƒç)'] += l.vyse_uveru || 0;
            });
            return Object.values(grouped).sort((a, b) => a.month.localeCompare(b.month));
        }

        function calculateOwnerStats(loans) {
            const grouped = {};
            loans.forEach(l => {
                const owner = l.vlastnik || 'N/A';
                if (!grouped[owner]) grouped[owner] = { owner, count: 0, value: 0 };
                grouped[owner].count++;
                grouped[owner].value += l.vyse_uveru || 0;
            });
            return Object.values(grouped).sort((a, b) => b.value - a.value);
        }

        // =============================================================================
        // VYKRESLEN√ç DASHBOARDU
        // =============================================================================
        function renderDashboard() {
            const mainContent = document.getElementById('mainContent');
            
            // Update date badge s nov√Ωm form√°tem
            document.getElementById('dateBadge').textContent = 'üìÖ ' + formatDateTimePrague(DATA.timestamp);
            document.getElementById('missingDateCount').textContent = DATA.stats.total_loans - DATA.stats.total_loans_with_date;
            
            mainContent.innerHTML = `
                <!-- Stats -->
                <div class="stats-grid" id="statsGrid"></div>
                
                <!-- Alerts -->
                <div class="alerts-section">
                    <h2 class="section-title">‚ö†Ô∏è Upozornƒõn√≠ a Insights</h2>
                    <div class="alerts-grid" id="alertsGrid"></div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs" id="tabsContainer">
                    <button class="tab active" data-tab="overview">üìä P≈ôehled</button>
                    <button class="tab" data-tab="table">üìã Tabulka √∫vƒõr≈Ø</button>
                    <button class="tab" data-tab="tranches">üìë Tran≈°e</button>
                    <button class="tab" data-tab="owners">üë• Vlastn√≠ci</button>
                </div>
                
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterOverviewStatus">
                                <option value="">V≈°e</option>
                                <option value="splaceno">Splacen√©</option>
                                <option value="nesplaceno">Nesplacen√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="charts-grid" id="chartsGrid"></div>
                </div>
                
                <!-- Table Tab -->
                <div id="table" class="tab-content">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Hledat</label>
                            <input type="text" class="filter-input" id="searchInput" placeholder="N√°zev √∫vƒõru...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Typ √∫vƒõru</label>
                            <select class="filter-select" id="filterType"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rating</label>
                            <select class="filter-select" id="filterRating"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterStatus"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">LTV</label>
                            <select class="filter-select" id="filterLTV">
                                <option value="">V≈°e</option>
                                <option value="0-50">0-50%</option>
                                <option value="50-75">50-75%</option>
                                <option value="75+">75%+</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Probl√©my</label>
                            <select class="filter-select" id="filterProblems">
                                <option value="">V≈°e</option>
                                <option value="overdue">Po splatnosti</option>
                                <option value="highltv">Vysok√© LTV</option>
                                <option value="extended">Prodlou≈æen√©</option>
                            </select>
                        </div>
                        <button class="reset-btn" id="resetFilters">Reset</button>
                    </div>
                    <div class="table-card">
                        <div class="table-wrapper">
                            <table id="loansTable">
                                <thead id="loansTableHeader">
                                    <tr>
                                        <th data-column="jmeno">N√°zev</th>
                                        <th data-column="typ_uveru">Typ</th>
                                        <th data-column="rating">Rating</th>
                                        <th data-column="vyse_uveru">V√Ω≈°e √∫vƒõru</th>
                                        <th data-column="ltv">LTV</th>
                                        <th data-column="datum_splatnosti">Splatnost</th>
                                        <th data-column="stav_splaceni">Stav</th>
                                        <th data-column="vlastnik">Vlastn√≠k</th>
                                    </tr>
                                </thead>
                                <tbody id="loansTableBody"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <div class="page-info" id="pageInfo"></div>
                            <div class="page-buttons" id="pageButtons"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tranches Tab -->
                <div id="tranches" class="tab-content">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Hledat</label>
                            <input type="text" class="filter-input" id="searchInputTranche" placeholder="N√°zev √∫vƒõru...">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Rating</label>
                            <select class="filter-select" id="filterRatingTranche"><option value="">V≈°e</option></select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterStatusTranche"><option value="">V≈°e</option></select>
                        </div>
                        <button class="reset-btn" id="resetFiltersTranche">Reset</button>
                    </div>
                    <div class="table-card">
                        <div class="table-wrapper">
                            <table id="tranchesTable">
                                <thead id="trancheTableHeader">
                                    <tr>
                                        <th data-column="jmeno">N√°zev √∫vƒõru</th>
                                        <th data-column="cislo_transe">Tran≈°e</th>
                                        <th data-column="rating">Rating</th>
                                        <th data-column="vyse_transe">V√Ω≈°e tran≈°e</th>
                                        <th data-column="datum_splatnosti">Splatnost</th>
                                        <th data-column="stav_splaceni">Stav</th>
                                    </tr>
                                </thead>
                                <tbody id="tranchesTableBody"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <div class="page-info" id="pageInfoTranche"></div>
                            <div class="page-buttons" id="pageButtonsTranche"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Owners Tab -->
                <div id="owners" class="tab-content">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Stav splacen√≠</label>
                            <select class="filter-select" id="filterOwnersStatus">
                                <option value="">V≈°e</option>
                                <option value="splaceno">Splacen√©</option>
                                <option value="nesplaceno">Nesplacen√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="owners-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">üèÜ Top 20 vlastn√≠k≈Ø podle objemu √∫vƒõr≈Ø</h3>
                            <div class="chart-container tall"><canvas id="ownersValueChart"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">üìä Top 20 vlastn√≠k≈Ø podle poƒçtu √∫vƒõr≈Ø</h3>
                            <div class="chart-container tall"><canvas id="ownersCountChart"></canvas></div>
                        </div>
                    </div>
                    <div class="sub-section">
                        <h3 class="sub-title">üìã Kompletn√≠ p≈ôehled vlastn√≠k≈Ø</h3>
                        <div class="table-card">
                            <div class="table-wrapper">
                                <table id="ownersTable">
                                    <thead>
                                        <tr>
                                            <th>Vlastn√≠k</th>
                                            <th>Poƒçet √∫vƒõr≈Ø</th>
                                            <th>Celkov√Ω objem</th>
                                            <th>√ò na √∫vƒõr</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ownersTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            renderStats();
            renderAlerts();
            renderOverviewCharts();
            populateFilters();
            applyFilters();
            applyFiltersTranche();
            renderOwnersTab();
            setupEventListeners();
        }

        function renderStats() {
            const stats = DATA.stats;
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Celkem √∫vƒõr≈Ø</div>
                    <div class="stat-value" style="color: var(--accent-blue)">${formatNumber(stats.total_loans)}</div>
                    <div class="stat-sub">s datem: ${stats.total_loans_with_date}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Poƒçet tran≈°√≠</div>
                    <div class="stat-value" style="color: var(--accent-purple)">${formatNumber(stats.total_tranches)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Celkov√Ω objem</div>
                    <div class="stat-value" style="color: var(--accent-green)">${(stats.total_value / 1e9).toFixed(2)} mld.</div>
                    <div class="stat-sub">${formatCurrency(stats.total_value)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Po splatnosti</div>
                    <div class="stat-value" style="color: var(--accent-red)">${stats.overdue_count}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Splatnost do 30 dn√≠</div>
                    <div class="stat-value" style="color: var(--accent-yellow)">${stats.due_30_days}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Celkov√© pohled√°vky</div>
                    <div class="stat-value" style="color: var(--accent-orange)">${formatCurrency(stats.total_receivables)}</div>
                </div>
            `;
        }

        function renderAlerts() {
            const alertsGrid = document.getElementById('alertsGrid');
            if (DATA.insights.length === 0) {
                alertsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>≈Ω√°dn√° upozornƒõn√≠</p></div>';
                return;
            }
            
            alertsGrid.innerHTML = DATA.insights.map((insight, idx) => `
                <div class="alert-card ${insight.type}" onclick="toggleAlert(${idx})">
                    <div class="alert-header">
                        <div>
                            <div class="alert-title">${insight.title}</div>
                            <div class="alert-value">${formatCurrency(insight.value)}</div>
                        </div>
                        <div class="alert-count">${insight.count}</div>
                    </div>
                    <div class="alert-items">
                        ${insight.items.map(item => `
                            <div class="alert-item">
                                <span class="alert-item-name">${item.name}</span>
                                <span class="alert-item-value">${item.extra || formatCurrency(item.value)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleAlert(idx) {
            const cards = document.querySelectorAll('.alert-card');
            cards[idx].classList.toggle('expanded');
        }

        function renderOverviewCharts(statusFilter = '') {
            let ratingStats, typeStats, ltvDist, loanValueDist;
            
            if (statusFilter === 'splaceno') {
                ratingStats = DATA.rating_stats_splaceno;
                typeStats = DATA.type_stats_splaceno;
                ltvDist = DATA.ltv_distribution_splaceno;
                loanValueDist = DATA.loan_value_distribution_splaceno;
            } else if (statusFilter === 'nesplaceno') {
                ratingStats = DATA.rating_stats_nesplaceno;
                typeStats = DATA.type_stats_nesplaceno;
                ltvDist = DATA.ltv_distribution_nesplaceno;
                loanValueDist = DATA.loan_value_distribution_nesplaceno;
            } else {
                ratingStats = DATA.rating_stats_all;
                typeStats = DATA.type_stats_all;
                ltvDist = DATA.ltv_distribution_all;
                loanValueDist = DATA.loan_value_distribution_all;
            }

            Object.values(overviewCharts).forEach(c => c && c.destroy());
            overviewCharts = {};

            // Generate chart grid HTML - 15 graf≈Ø podle po≈æadavk≈Ø
            document.getElementById('chartsGrid').innerHTML = `
                <div class="chart-card"><h3 class="chart-title">üìä Rating ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="ratingCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ Rating ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="ratingValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìâ Rating ‚Äì pr≈Ømƒõrn√© LTV (%)</h3><div class="chart-container"><canvas id="avgLtvChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìà LTV ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="ltvCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ LTV ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="ltvValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìä Poƒçet tran≈°√≠ na √∫vƒõr</h3><div class="chart-container"><canvas id="tranchesDistChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üîÑ Typ √∫vƒõru ‚Äì poƒçet</h3><div class="chart-container"><canvas id="typeCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ Typ √∫vƒõru ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="typeValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üë• Poƒçet vlastn√≠k≈Ø na √∫vƒõr</h3><div class="chart-container"><canvas id="ownersDistChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">‚úÖ Stav splacen√≠ ‚Äì poƒçet</h3><div class="chart-container"><canvas id="statusCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ Stav splacen√≠ ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="statusValueChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí≥ V√Ω≈°e √∫vƒõru ‚Äì poƒçet √∫vƒõr≈Ø</h3><div class="chart-container"><canvas id="loanValueCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üí∞ V√Ω≈°e √∫vƒõru ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="loanValueVolumeChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üìÖ Splatnost nesplacen√Ωch (mƒõs√≠ƒçnƒõ) ‚Äì poƒçet</h3><div class="chart-container"><canvas id="maturityCountChart"></canvas></div></div>
                <div class="chart-card"><h3 class="chart-title">üíµ Splatnost nesplacen√Ωch (mƒõs√≠ƒçnƒõ) ‚Äì objem (mld. Kƒç)</h3><div class="chart-container"><canvas id="maturityValueChart"></canvas></div></div>
            `;

            const ratingStatsSorted = ratingStats.sort((a, b) => a.Rating.localeCompare(b.Rating));
            const ratingColors = ratingStatsSorted.map(r => r.Rating.startsWith('A') ? 'rgba(16, 185, 129, 0.8)' : r.Rating.startsWith('B') ? 'rgba(59, 130, 246, 0.8)' : 'rgba(139, 92, 246, 0.8)');

            // 1. Rating ‚Äì poƒçet
            overviewCharts.ratingCount = new Chart(document.getElementById('ratingCountChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: 'Poƒçet', data: ratingStatsSorted.map(r => r['Loan ID']), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 2. Rating ‚Äì objem
            overviewCharts.ratingValue = new Chart(document.getElementById('ratingValueChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: 'Objem (mld. Kƒç)', data: ratingStatsSorted.map(r => r['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 3. Rating ‚Äì pr≈Ømƒõrn√© LTV
            overviewCharts.avgLtv = new Chart(document.getElementById('avgLtvChart'), {
                type: 'bar', data: { labels: ratingStatsSorted.map(r => r.Rating), datasets: [{ label: '√ò LTV (%)', data: ratingStatsSorted.map(r => r.avgLtv), backgroundColor: ratingColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            const ltvColors = ltvDist.map(d => d.range.includes('80') ? 'rgba(239, 68, 68, 0.8)' : d.range.includes('75') ? 'rgba(245, 158, 11, 0.8)' : 'rgba(16, 185, 129, 0.8)');

            // 4. LTV ‚Äì poƒçet
            overviewCharts.ltvCount = new Chart(document.getElementById('ltvCountChart'), {
                type: 'bar', data: { labels: ltvDist.map(d => d.range), datasets: [{ label: 'Poƒçet', data: ltvDist.map(d => d.count), backgroundColor: ltvColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 5. LTV ‚Äì objem
            overviewCharts.ltvValue = new Chart(document.getElementById('ltvValueChart'), {
                type: 'bar', data: { labels: ltvDist.map(d => d.range), datasets: [{ label: 'Objem (mld. Kƒç)', data: ltvDist.map(d => d.value / 1e9), backgroundColor: ltvColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 6. Poƒçet tran≈°√≠ na √∫vƒõr
            const tranchesDist = DATA.tranches_distribution;
            overviewCharts.tranchesDist = new Chart(document.getElementById('tranchesDistChart'), {
                type: 'bar', data: { labels: tranchesDist.map(d => d.tranches + ' tran≈°' + (d.tranches === 1 ? 'e' : d.tranches < 5 ? 'e' : '√≠')), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: tranchesDist.map(d => d.count), backgroundColor: 'rgba(139, 92, 246, 0.7)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 7. Typ √∫vƒõru ‚Äì poƒçet
            overviewCharts.typeCount = new Chart(document.getElementById('typeCountChart'), {
                type: 'doughnut', data: { labels: typeStats.map(t => t['Typ √∫vƒõru']), datasets: [{ data: typeStats.map(t => t['Loan ID']), backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 8. Typ √∫vƒõru ‚Äì objem
            overviewCharts.typeValue = new Chart(document.getElementById('typeValueChart'), {
                type: 'doughnut', data: { labels: typeStats.map(t => t['Typ √∫vƒõru']), datasets: [{ data: typeStats.map(t => t['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 9. Poƒçet vlastn√≠k≈Ø na √∫vƒõr (NOV√ù)
            const ownersDist = DATA.owners_distribution;
            overviewCharts.ownersDist = new Chart(document.getElementById('ownersDistChart'), {
                type: 'bar', data: { labels: ownersDist.map(d => d.owners + ' vlastn√≠k' + (d.owners === 1 ? '' : d.owners < 5 ? 'y' : '≈Ø')), datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: ownersDist.map(d => d.count), backgroundColor: 'rgba(6, 182, 212, 0.7)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 10. Stav splacen√≠ ‚Äì poƒçet
            const statusStats = DATA.status_stats;
            overviewCharts.statusCount = new Chart(document.getElementById('statusCountChart'), {
                type: 'doughnut', data: { labels: statusStats.map(s => s['Stav splacen√≠']), datasets: [{ data: statusStats.map(s => s['Loan ID']), backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            // 11. Stav splacen√≠ ‚Äì objem
            overviewCharts.statusValue = new Chart(document.getElementById('statusValueChart'), {
                type: 'doughnut', data: { labels: statusStats.map(s => s['Stav splacen√≠']), datasets: [{ data: statusStats.map(s => s['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), backgroundColor: ['#ef4444', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#8888a0' } } } }
            });

            const loanValueColors = 'rgba(249, 115, 22, 0.7)';

            // 12. V√Ω≈°e √∫vƒõru ‚Äì poƒçet (NOV√ù)
            overviewCharts.loanValueCount = new Chart(document.getElementById('loanValueCountChart'), {
                type: 'bar', data: { labels: loanValueDist.map(d => d.range), datasets: [{ label: 'Poƒçet', data: loanValueDist.map(d => d.count), backgroundColor: loanValueColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 13. V√Ω≈°e √∫vƒõru ‚Äì objem (NOV√ù)
            overviewCharts.loanValueVolume = new Chart(document.getElementById('loanValueVolumeChart'), {
                type: 'bar', data: { labels: loanValueDist.map(d => d.range), datasets: [{ label: 'Objem (mld. Kƒç)', data: loanValueDist.map(d => d.value / 1e9), backgroundColor: loanValueColors, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0' } } } }
            });

            // 14. Splatnost nesplacen√Ωch ‚Äì poƒçet (NOV√ù)
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const maturityData = DATA.monthly.filter(m => m.month >= currentMonth);
            
            overviewCharts.maturityCount = new Chart(document.getElementById('maturityCountChart'), {
                type: 'line', data: { labels: maturityData.map(m => m.month), datasets: [{ label: 'Poƒçet', data: maturityData.map(m => m['Loan ID']), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0', maxRotation: 45 } } } }
            });

            // 15. Splatnost nesplacen√Ωch ‚Äì objem
            overviewCharts.maturityValue = new Chart(document.getElementById('maturityValueChart'), {
                type: 'line', data: { labels: maturityData.map(m => m.month), datasets: [{ label: 'Objem (mld. Kƒç)', data: maturityData.map(m => m['V√Ω≈°e √∫vƒõru (Kƒç)'] / 1e9), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, x: { grid: { display: false }, ticks: { color: '#8888a0', maxRotation: 45 } } } }
            });
        }

        function populateFilters() {
            DATA.filters.typy.forEach(t => { document.getElementById('filterType').innerHTML += `<option value="${t}">${t}</option>`; });
            DATA.filters.ratings.forEach(r => {
                document.getElementById('filterRating').innerHTML += `<option value="${r}">${r}</option>`;
                document.getElementById('filterRatingTranche').innerHTML += `<option value="${r}">${r}</option>`;
            });
            DATA.filters.stavy.forEach(s => {
                document.getElementById('filterStatus').innerHTML += `<option value="${s}">${s}</option>`;
                document.getElementById('filterStatusTranche').innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const rating = document.getElementById('filterRating').value;
            const status = document.getElementById('filterStatus').value;
            const ltv = document.getElementById('filterLTV').value;
            const problems = document.getElementById('filterProblems').value;

            filteredData = DATA.loans.filter(item => {
                if (search && !item.jmeno.toLowerCase().includes(search) && !(item.vlastnik || '').toLowerCase().includes(search)) return false;
                if (type && item.typ_uveru !== type) return false;
                if (rating && item.rating !== rating) return false;
                if (status && item.stav_splaceni !== status) return false;
                if (ltv) {
                    const ltvVal = item.ltv || 0;
                    if (ltv === '0-50' && ltvVal >= 50) return false;
                    if (ltv === '50-75' && (ltvVal < 50 || ltvVal >= 75)) return false;
                    if (ltv === '75+' && ltvVal < 75) return false;
                }
                if (problems) {
                    if (problems === 'overdue' && !(item.days_to_maturity < 0 && item.stav_splaceni !== 'Splaceno')) return false;
                    if (problems === 'highltv' && !(item.ltv > 75)) return false;
                    if (problems === 'extended' && !(item.prodlouzeni === true || item.prodlouzeni === 'Ano')) return false;
                }
                return true;
            });

            if (sortColumn) {
                filteredData.sort((a, b) => {
                    let aVal = a[sortColumn], bVal = b[sortColumn];
                    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                    if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);

            document.getElementById('loansTableBody').innerHTML = pageData.map(loan => {
                const isOverdue = loan.days_to_maturity < 0 && loan.stav_splaceni !== 'Splaceno';
                const statusClass = loan.stav_splaceni === 'Splaceno' ? 'success' : isOverdue ? 'danger' : 'info';
                return `<tr>
                    <td>${loan.jmeno || ''}</td>
                    <td>${loan.typ_uveru || ''}</td>
                    <td><span class="badge ${loan.rating?.startsWith('A') ? 'success' : loan.rating?.startsWith('B') ? 'info' : 'warning'}">${loan.rating || ''}</span></td>
                    <td class="currency">${formatCurrency(loan.vyse_uveru)}</td>
                    <td>${formatPercent(loan.ltv)}</td>
                    <td>${formatDate(loan.datum_splatnosti)}</td>
                    <td><span class="badge ${statusClass}">${loan.stav_splaceni || ''}</span></td>
                    <td>${loan.vlastnik || ''}</td>
                </tr>`;
            }).join('');

            const totalPages = Math.ceil(filteredData.length / pageSize);
            document.getElementById('pageInfo').textContent = `Zobrazeno ${start + 1}-${Math.min(end, filteredData.length)} z ${filteredData.length}`;
            
            let buttons = '';
            if (currentPage > 1) buttons += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">‚Üê</button>`;
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            if (currentPage < totalPages) buttons += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">‚Üí</button>`;
            document.getElementById('pageButtons').innerHTML = buttons;
        }

        function goToPage(page) { currentPage = page; renderTable(); }

        function applyFiltersTranche() {
            const search = document.getElementById('searchInputTranche').value.toLowerCase();
            const rating = document.getElementById('filterRatingTranche').value;
            const status = document.getElementById('filterStatusTranche').value;

            filteredTranches = DATA.tranches.filter(item => {
                if (search && !item.jmeno.toLowerCase().includes(search)) return false;
                if (rating && item.rating !== rating) return false;
                if (status && item.stav_splaceni !== status) return false;
                return true;
            });

            if (sortColumnTranche) {
                filteredTranches.sort((a, b) => {
                    let aVal = a[sortColumnTranche], bVal = b[sortColumnTranche];
                    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                    if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                    if (aVal < bVal) return sortDirectionTranche === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirectionTranche === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            currentPageTranche = 1;
            renderTranchesTable();
        }

        function renderTranchesTable() {
            const start = (currentPageTranche - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredTranches.slice(start, end);

            document.getElementById('tranchesTableBody').innerHTML = pageData.map(tr => {
                const statusClass = tr.stav_splaceni === 'Splaceno' ? 'success' : 'info';
                return `<tr>
                    <td>${tr.jmeno || ''}</td>
                    <td>${tr.cislo_transe || ''}</td>
                    <td><span class="badge ${tr.rating?.startsWith('A') ? 'success' : tr.rating?.startsWith('B') ? 'info' : 'warning'}">${tr.rating || ''}</span></td>
                    <td class="currency">${formatCurrency(tr.vyse_transe)}</td>
                    <td>${formatDate(tr.datum_splatnosti)}</td>
                    <td><span class="badge ${statusClass}">${tr.stav_splaceni || ''}</span></td>
                </tr>`;
            }).join('');

            const totalPages = Math.ceil(filteredTranches.length / pageSize);
            document.getElementById('pageInfoTranche').textContent = `Zobrazeno ${start + 1}-${Math.min(end, filteredTranches.length)} z ${filteredTranches.length}`;
            
            let buttons = '';
            if (currentPageTranche > 1) buttons += `<button class="page-btn" onclick="goToPageTranche(${currentPageTranche - 1})">‚Üê</button>`;
            for (let i = Math.max(1, currentPageTranche - 2); i <= Math.min(totalPages, currentPageTranche + 2); i++) {
                buttons += `<button class="page-btn ${i === currentPageTranche ? 'active' : ''}" onclick="goToPageTranche(${i})">${i}</button>`;
            }
            if (currentPageTranche < totalPages) buttons += `<button class="page-btn" onclick="goToPageTranche(${currentPageTranche + 1})">‚Üí</button>`;
            document.getElementById('pageButtonsTranche').innerHTML = buttons;
        }

        function goToPageTranche(page) { currentPageTranche = page; renderTranchesTable(); }

        function renderOwnersTab(statusFilter = '') {
            let ownerStats;
            if (statusFilter === 'splaceno') {
                ownerStats = DATA.owner_stats_splaceno;
            } else if (statusFilter === 'nesplaceno') {
                ownerStats = DATA.owner_stats_nesplaceno;
            } else {
                ownerStats = DATA.owner_stats;
            }

            if (ownersValueChart) ownersValueChart.destroy();
            if (ownersCountChart) ownersCountChart.destroy();

            const top20 = ownerStats.slice(0, 20);

            ownersValueChart = new Chart(document.getElementById('ownersValueChart'), {
                type: 'bar',
                data: {
                    labels: top20.map(o => o.owner.length > 25 ? o.owner.substring(0, 25) + '...' : o.owner),
                    datasets: [{ label: 'Objem (mld. Kƒç)', data: top20.map(o => o.value / 1e9), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, y: { grid: { display: false }, ticks: { color: '#8888a0', font: { size: 11 } } } } }
            });

            const top20ByCount = [...ownerStats].sort((a, b) => b.count - a.count).slice(0, 20);
            ownersCountChart = new Chart(document.getElementById('ownersCountChart'), {
                type: 'bar',
                data: {
                    labels: top20ByCount.map(o => o.owner.length > 25 ? o.owner.substring(0, 25) + '...' : o.owner),
                    datasets: [{ label: 'Poƒçet √∫vƒõr≈Ø', data: top20ByCount.map(o => o.count), backgroundColor: 'rgba(139, 92, 246, 0.7)', borderRadius: 6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#8888a0' } }, y: { grid: { display: false }, ticks: { color: '#8888a0', font: { size: 11 } } } } }
            });

            document.getElementById('ownersTableBody').innerHTML = ownerStats.map(o => `
                <tr>
                    <td>${o.owner}</td>
                    <td>${o.count}</td>
                    <td class="currency">${formatCurrency(o.value)}</td>
                    <td class="currency">${formatCurrency(o.value / o.count)}</td>
                </tr>
            `).join('');
        }

        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            ['searchInput', 'filterType', 'filterRating', 'filterStatus', 'filterLTV', 'filterProblems'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFilters);
                document.getElementById(id).addEventListener('change', applyFilters);
            });

            document.getElementById('resetFilters').addEventListener('click', () => {
                ['searchInput', 'filterType', 'filterRating', 'filterStatus', 'filterLTV', 'filterProblems'].forEach(id => document.getElementById(id).value = '');
                sortColumn = null; sortDirection = 'asc';
                applyFilters();
            });

            document.getElementById('loansTableHeader').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.column) return;
                if (sortColumn === th.dataset.column) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                else { sortColumn = th.dataset.column; sortDirection = 'asc'; }
                applyFilters();
            });

            ['searchInputTranche', 'filterRatingTranche', 'filterStatusTranche'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFiltersTranche);
                document.getElementById(id).addEventListener('change', applyFiltersTranche);
            });

            document.getElementById('resetFiltersTranche').addEventListener('click', () => {
                ['searchInputTranche', 'filterRatingTranche', 'filterStatusTranche'].forEach(id => document.getElementById(id).value = '');
                sortColumnTranche = null; sortDirectionTranche = 'asc';
                applyFiltersTranche();
            });

            document.getElementById('trancheTableHeader').addEventListener('click', (e) => {
                const th = e.target.closest('th');
                if (!th || !th.dataset.column) return;
                if (sortColumnTranche === th.dataset.column) sortDirectionTranche = sortDirectionTranche === 'asc' ? 'desc' : 'asc';
                else { sortColumnTranche = th.dataset.column; sortDirectionTranche = 'asc'; }
                applyFiltersTranche();
            });

            document.getElementById('filterOwnersStatus').addEventListener('change', (e) => renderOwnersTab(e.target.value));
            document.getElementById('filterOverviewStatus').addEventListener('change', (e) => renderOverviewCharts(e.target.value));
        }

        // Start
        loadData();
    </script>
</body>
</html>
